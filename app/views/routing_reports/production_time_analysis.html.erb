<%# app/views/routing_reports/production_time_analysis.html.erb %>

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Production Time Analysis</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i> Home</a>
        <a class="breadcrumb-item" href="#">Reports</a>
        <a class="breadcrumb-item" href="/reports/routing">Routing</a>

        <span class="breadcrumb-item active">Production Time Analysis</span>
      </nav>
    </div>
  </div>
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      
      <h2 class="mb-0">
        <i class="fas fa-clock me-2"></i> 
        Production Time Analysis Report
      </h2>
      <p class="text-muted">Lead times, bottlenecks, and production scheduling insights</p>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group">
        <%= link_to production_time_analysis_routing_path(format: :csv), class: "btn btn-success" do %>
          <i class="fas fa-file-csv me-2"></i> Export CSV
        <% end %>
        <%= link_to production_time_analysis_routing_path(format: :pdf), class: "btn btn-danger" do %>
          <i class="fas fa-file-pdf me-2"></i> Export PDF
        <% end %>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-primary">
        <div class="card-body text-center">
          <h3 class="text-primary mb-0"><%= @routings.count %></h3>
          <small class="text-muted">Active Routings</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <h3 class="text-info mb-0">
            <%= number_with_precision(@time_analysis.sum { |d| d[:setup_time] } / [@routings.count, 1].max, precision: 1) %>m
          </h3>
          <small class="text-muted">Avg Setup Time</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <h3 class="text-warning mb-0">
            <%= number_with_precision(@time_analysis.sum { |d| d[:run_time_per_unit] } / [@routings.count, 1].max, precision: 1) %>m
          </h3>
          <small class="text-muted">Avg Run Time/Unit</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <h3 class="text-success mb-0">
            <%= number_with_precision(@time_analysis.sum { |d| d[:operations_count] } / [@routings.count, 1].max, precision: 1) %>
          </h3>
          <small class="text-muted">Avg Operations</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Report Table -->
  <div class="card  mb-4">
    <div class="card-header d-flex justify-content-start align-items-center bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-table me-2"></i> Time Analysis by Routing
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Routing</th>
              <th class="text-center">Operations</th>
              <th class="text-end">Setup Time</th>
              <th class="text-end">Run Time/Unit</th>
              <th class="text-end">Wait Time</th>
              <th class="text-end">Move Time</th>
              <th class="text-end">Total/Unit</th>
              <th class="text-center">Bottleneck</th>
            </tr>
          </thead>
          <tbody>
            <% @time_analysis.sort_by { |d| -d[:total_time_per_unit] }.each do |data| %>
              <% routing = data[:routing] %>
              <tr>
                <td>
                  <strong><%= routing.product.sku %></strong>
                  <br>
                  <small class="text-muted"><%= truncate(routing.product.name, length: 30) %></small>
                </td>
                <td>
                  <%= link_to routing.code, routing_path(routing) %>
                  <br>
                  <small class="text-muted">Rev <%= routing.revision %></small>
                </td>
                <td class="text-center">
                  <span class="text-white badge bg-secondary"><%= data[:operations_count] %></span>
                </td>
                <td class="text-end">
                  <strong><%= number_with_precision(data[:setup_time], precision: 1) %></strong>
                  <small class="text-muted">min</small>
                </td>
                <td class="text-end">
                  <strong class="text-primary"><%= number_with_precision(data[:run_time_per_unit], precision: 1) %></strong>
                  <small class="text-muted">min</small>
                </td>
                <td class="text-end">
                  <%= number_with_precision(data[:wait_time], precision: 1) %>
                  <small class="text-muted">min</small>
                </td>
                <td class="text-end">
                  <%= number_with_precision(data[:move_time], precision: 1) %>
                  <small class="text-muted">min</small>
                </td>
                <td class="text-end">
                  <strong class="text-success fs-6">
                    <%= number_with_precision(data[:total_time_per_unit], precision: 1) %>
                  </strong>
                  <small class="text-muted">min</small>
                </td>
                <td class="text-center">
                  <% if data[:bottleneck_pct] > 0 %>
                    <div class="progress" style="height: 20px; min-width: 60px;">
                      <div class="progress-bar <%= data[:bottleneck_pct] > 50 ? 'bg-danger' : data[:bottleneck_pct] > 30 ? 'bg-warning' : 'bg-success' %>" 
                           style="width: <%= data[:bottleneck_pct] %>%"
                           title="<%= data[:bottleneck_pct] %>% of total time">
                        <%= data[:bottleneck_pct] %>%
                      </div>
                    </div>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
              </tr>
              
              <!-- Expandable Batch Time Estimates -->
              <tr class="collapse" id="batch-times-<%= routing.id %>">
                <td colspan="9" class="bg-primary">
                  <div class="p-3">
                    <h6 class="mb-3">
                      <i class="fas fa-calculator me-2"></i> 
                      Batch Time Estimates
                    </h6>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="card">
                          <div class="card-body text-center">
                            <h6 class="text-muted">Batch of 10 units</h6>
                            <h4 class="text-primary mb-0">
                              <%= number_with_precision(data[:time_for_batches][:batch_10], precision: 1) %>
                            </h4>
                            <small class="text-muted">
                              minutes (<%= number_with_precision(data[:time_for_batches][:batch_10] / 60.0, precision: 1) %> hours)
                            </small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="card">
                          <div class="card-body text-center">
                            <h6 class="text-muted">Batch of 50 units</h6>
                            <h4 class="text-info mb-0">
                              <%= number_with_precision(data[:time_for_batches][:batch_50], precision: 1) %>
                            </h4>
                            <small class="text-muted">
                              minutes (<%= number_with_precision(data[:time_for_batches][:batch_50] / 60.0, precision: 1) %> hours)
                            </small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="card">
                          <div class="card-body text-center">
                            <h6 class="text-muted">Batch of 100 units</h6>
                            <h4 class="text-success mb-0">
                              <%= number_with_precision(data[:time_for_batches][:batch_100], precision: 1) %>
                            </h4>
                            <small class="text-muted">
                              minutes (<%= number_with_precision(data[:time_for_batches][:batch_100] / 60.0, precision: 1) %> hours)
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <% if data[:critical_operation] %>
                      <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        <strong>Critical Operation (Bottleneck):</strong> 
                        <%= data[:critical_operation].operation_sequence %> - 
                        <%= data[:critical_operation].operation_name %> 
                        (<%= number_with_precision(data[:critical_operation].total_time_per_unit, precision: 1) %> min/unit)
                        at <%= data[:critical_operation].work_center.name %>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
              
              <!-- Toggle Button -->
              <tr>
                <td colspan="9" class="py-0">
                  <a class="btn btn-link btn-sm w-100 text-decoration-none" 
                     data-toggle="collapse" 
                     href="#batch-times-<%= routing.id %>">
                    <i class="fas fa-chevron-down me-1"></i> 
                    View Batch Estimates & Critical Operation
                  </a>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Time Breakdown Chart -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary">
          <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i> Time Breakdown Comparison
          </h5>
        </div>
        <div class="card-body">
          <canvas id="timeBreakdownChart" height="100"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary">
          <h5 class="mb-0">
            <i class="fas fa-chart-pie me-2"></i> Avg Time Distribution
          </h5>
        </div>
        <div class="card-body">
          <canvas id="timeDistributionChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottleneck Analysis -->
  <div class="row">
    <div class="col-md-6">
      <div class="card  border-danger">
        <div class="card-header d-flex justify-content-start align-items-center bg-danger text-white">
          <h6 class="mb-0">
            <i class="fas fa-hourglass-half me-2"></i> Longest Lead Times
          </h6>
        </div>
        <div class="card-body">
          <% longest = @time_analysis.sort_by { |d| -d[:total_time_per_unit] }.first(5) %>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-end">Time/Unit</th>
                  <th class="text-end">100 Units</th>
                </tr>
              </thead>
              <tbody>
                <% longest.each do |data| %>
                  <tr>
                    <td>
                      <strong><%= data[:routing].product.sku %></strong>
                      <br>
                      <small class="text-muted">
                        <%= data[:operations_count] %> ops
                      </small>
                    </td>
                    <td class="text-end">
                      <strong class="text-danger">
                        <%= number_with_precision(data[:total_time_per_unit], precision: 1) %>m
                      </strong>
                    </td>
                    <td class="text-end">
                      <%= number_with_precision(data[:time_for_batches][:batch_100] / 60.0, precision: 1) %>h
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="alert alert-warning mt-3 mb-0">
            <small>
              <i class="fas fa-lightbulb me-1"></i> 
              Consider optimizing these routings to reduce production time
            </small>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card  border-success">
        <div class="card-header d-flex justify-content-start align-items-center bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-tachometer-alt me-2"></i> Fastest Production Times
          </h6>
        </div>
        <div class="card-body">
          <% fastest = @time_analysis.sort_by { |d| d[:total_time_per_unit] }.first(5) %>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-end">Time/Unit</th>
                  <th class="text-end">100 Units</th>
                </tr>
              </thead>
              <tbody>
                <% fastest.each do |data| %>
                  <tr>
                    <td>
                      <strong><%= data[:routing].product.sku %></strong>
                      <br>
                      <small class="text-muted">
                        <%= data[:operations_count] %> ops
                      </small>
                    </td>
                    <td class="text-end">
                      <strong class="text-success">
                        <%= number_with_precision(data[:total_time_per_unit], precision: 1) %>m
                      </strong>
                    </td>
                    <td class="text-end">
                      <%= number_with_precision(data[:time_for_batches][:batch_100] / 60.0, precision: 1) %>h
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="alert alert-success mt-3 mb-0">
            <small>
              <i class="fas fa-check-circle me-1"></i> 
              These routings demonstrate efficient production processes
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Critical Operations Summary -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i> 
            Bottleneck Operations by Work Center
          </h5>
        </div>
        <div class="card-body">
          <% 
            critical_ops = @time_analysis.map { |d| d[:critical_operation] }.compact
            wc_bottlenecks = critical_ops.group_by { |op| op.work_center.name }
          %>
          <% if wc_bottlenecks.any? %>
            <div class="row">
              <% wc_bottlenecks.sort_by { |wc, ops| -ops.count }.each do |wc_name, ops| %>
                <div class="col-md-4 mb-3">
                  <div class="card">
                    <div class="card-body">
                      <h6 class="card-title">
                        <i class="fas fa-industry me-2 text-warning"></i> 
                        <%= wc_name %>
                      </h6>
                      <p class="mb-2">
                        <span class="text-white badge bg-danger"><%= ops.count %></span>
                        bottleneck operations
                      </p>
                      <small class="text-muted">
                        Avg time: <%= number_with_precision(ops.sum(&:total_time_per_unit) / ops.count, precision: 1) %> min/unit
                      </small>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted mb-0">No bottleneck analysis available</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Stacked Bar Chart - Time Breakdown
  const barCtx = document.getElementById('timeBreakdownChart').getContext('2d');
  
  const products = <%= raw @time_analysis.first(10).map { |d| d[:routing].product.sku }.to_json %>;
  const setupTimes = <%= raw @time_analysis.first(10).map { |d| d[:setup_time] }.to_json %>;
  const runTimes = <%= raw @time_analysis.first(10).map { |d| d[:run_time_per_unit] }.to_json %>;
  const waitTimes = <%= raw @time_analysis.first(10).map { |d| d[:wait_time] }.to_json %>;
  const moveTimes = <%= raw @time_analysis.first(10).map { |d| d[:move_time] }.to_json %>;
  
  new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: products,
      datasets: [
        {
          label: 'Setup Time',
          data: setupTimes,
          backgroundColor: 'rgba(13, 110, 253, 0.6)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 1
        },
        {
          label: 'Run Time/Unit',
          data: runTimes,
          backgroundColor: 'rgba(40, 167, 69, 0.6)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 1
        },
        {
          label: 'Wait Time',
          data: waitTimes,
          backgroundColor: 'rgba(255, 193, 7, 0.6)',
          borderColor: 'rgba(255, 193, 7, 1)',
          borderWidth: 1
        },
        {
          label: 'Move Time',
          data: moveTimes,
          backgroundColor: 'rgba(13, 202, 240, 0.6)',
          borderColor: 'rgba(13, 202, 240, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          stacked: true
        },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + ' min';
            }
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' min';
            }
          }
        }
      }
    }
  });
  
  // Pie Chart - Average Time Distribution
  const pieCtx = document.getElementById('timeDistributionChart').getContext('2d');
  
  const avgSetup = <%= @time_analysis.sum { |d| d[:setup_time] } / [@routings.count, 1].max %>;
  const avgRun = <%= @time_analysis.sum { |d| d[:run_time_per_unit] } / [@routings.count, 1].max %>;
  const avgWait = <%= @time_analysis.sum { |d| d[:wait_time] } / [@routings.count, 1].max %>;
  const avgMove = <%= @time_analysis.sum { |d| d[:move_time] } / [@routings.count, 1].max %>;
  
  new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: ['Setup', 'Run', 'Wait', 'Move'],
      datasets: [{
        data: [avgSetup, avgRun, avgWait, avgMove],
        backgroundColor: [
          'rgba(13, 110, 253, 0.8)',
          'rgba(40, 167, 69, 0.8)',
          'rgba(255, 193, 7, 0.8)',
          'rgba(13, 202, 240, 0.8)'
        ],
        borderColor: [
          'rgba(13, 110, 253, 1)',
          'rgba(40, 167, 69, 1)',
          'rgba(255, 193, 7, 1)',
          'rgba(13, 202, 240, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed.toFixed(1) + ' min';
            }
          }
        }
      }
    }
  });
});
</script>