<%# app/views/routing_reports/operations_summary.html.erb %>

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">ROperations Summary</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>  Home</a>
        <a class="breadcrumb-item" href="#">Reports</a>
        <a class="breadcrumb-item" href="/reports/routing">Routing</a>

        <span class="breadcrumb-item active">ROperations Summary</span>
      </nav>
    </div>
  </div>
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="mb-0">
        <i class="fas fa-cogs me-2"></i>
        Operations Summary Report
      </h2>
      <p class="text-muted">Aggregate statistics by work center across all active routings</p>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group">
        <%= link_to operations_summary_routing_path(format: :csv), class: "btn btn-success" do %>
          <i class="fas fa-file-csv me-2"></i>Export CSV
        <% end %>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-primary">
        <div class="card-body text-center">
          <h3 class="text-primary mb-0">
            <%= @operations_data.sum(&:operations_count) %>
          </h3>
          <small class="text-muted">Total Operations</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <h3 class="text-info mb-0">
            <%= @operations_data.count %>
          </h3>
          <small class="text-muted">Work Centers Used</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <h3 class="text-warning mb-0">
            <%= number_with_precision(@operations_data.sum(&:total_setup), precision: 0) %>
          </h3>
          <small class="text-muted">Total Setup Time (min)</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <h3 class="text-success mb-0">
            $<%= number_with_precision(@operations_data.sum(&:total_labor_cost) + @operations_data.sum(&:total_overhead_cost), precision: 0) %>
          </h3>
          <small class="text-muted">Total Processing Cost</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Report Table -->
  <div class="card  mb-4">
    <div class="card-header d-flex justify-content-start align-items-center bg-secondary text-white">
      <h5 class="mb-0">
        <i class="fas fa-table me-2"></i>Operations Grouped by Work Center
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Work Center</th>
              <th class="text-center">Operations Count</th>
              <th class="text-end">Total Setup Time</th>
              <th class="text-end">Avg Run Time/Unit</th>
              <th class="text-end">Total Labor Cost</th>
              <th class="text-end">Total Overhead Cost</th>
              <th class="text-end">Total Processing Cost</th>
              <th class="text-center">Utilization</th>
            </tr>
          </thead>
          <tbody>
            <% @operations_data.each do |data| %>
              <tr>
                <td>
                  <strong><%= data.wc_code %></strong>
                  <br>
                  <small class="text-muted"><%= data.wc_name %></small>
                </td>
                <td class="text-center">
                  <span class="text-white badge bg-primary fs-6"><%= data.operations_count %></span>
                </td>
                <td class="text-end">
                  <strong><%= number_with_precision(data.total_setup, precision: 1) %></strong>
                  <small class="text-muted">min</small>
                  <br>
                  <small class="text-muted">
                    Avg: <%= number_with_precision(data.total_setup / data.operations_count, precision: 1) %>m
                  </small>
                </td>
                <td class="text-end">
                  <strong class="text-info"><%= number_with_precision(data.avg_run_time, precision: 2) %></strong>
                  <small class="text-muted">min</small>
                </td>
                <td class="text-end">
                  <strong class="text-primary">
                    $<%= number_with_precision(data.total_labor_cost, precision: 2) %>
                  </strong>
                  <br>
                  <small class="text-muted">
                    Avg: $<%= number_with_precision(data.total_labor_cost / data.operations_count, precision: 2) %>
                  </small>
                </td>
                <td class="text-end">
                  <strong class="text-warning">
                    $<%= number_with_precision(data.total_overhead_cost, precision: 2) %>
                  </strong>
                  <br>
                  <small class="text-muted">
                    Avg: $<%= number_with_precision(data.total_overhead_cost / data.operations_count, precision: 2) %>
                  </small>
                </td>
                <td class="text-end">
                  <strong class="text-success fs-5">
                    $<%= number_with_precision(data.total_labor_cost + data.total_overhead_cost, precision: 2) %>
                  </strong>
                </td>
                <td class="text-center">
                  <% utilization = [data.operations_count * 10, 100].min %>
                  <div class="progress" style="height: 25px; min-width: 80px;">
                    <div class="progress-bar <%= utilization >= 70 ? 'bg-success' : utilization >= 40 ? 'bg-warning' : 'bg-danger' %>" 
                         style="width: <%= utilization %>%">
                      <strong><%= utilization %>%</strong>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td><strong>TOTALS</strong></td>
              <td class="text-center">
                <strong><%= @operations_data.sum(&:operations_count) %></strong>
              </td>
              <td class="text-end">
                <strong><%= number_with_precision(@operations_data.sum(&:total_setup), precision: 1) %>m</strong>
              </td>
              <td class="text-end">
                <strong><%= number_with_precision(@operations_data.sum { |d| d.avg_run_time * d.operations_count } / @operations_data.sum(&:operations_count), precision: 2) %>m</strong>
              </td>
              <td class="text-end">
                <strong class="text-primary">$<%= number_with_precision(@operations_data.sum(&:total_labor_cost), precision: 2) %></strong>
              </td>
              <td class="text-end">
                <strong class="text-warning">$<%= number_with_precision(@operations_data.sum(&:total_overhead_cost), precision: 2) %></strong>
              </td>
              <td class="text-end">
                <strong class="text-success">$<%= number_with_precision(@operations_data.sum(&:total_labor_cost) + @operations_data.sum(&:total_overhead_cost), precision: 2) %></strong>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Visual Analytics -->
  <div class="row mb-4">
    <!-- Operations Distribution -->
    <div class="col-md-6">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary">
          <h5 class="mb-0">
            <i class="fas fa-chart-pie me-2"></i>Operations Distribution by Work Center
          </h5>
        </div>
        <div class="card-body">
          <canvas id="operationsDistributionChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Cost Distribution -->
    <div class="col-md-6">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary">
          <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>Cost Distribution by Work Center
          </h5>
        </div>
        <div class="card-body">
          <canvas id="costDistributionChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Insights -->
  <div class="row">
    <!-- Most Used Work Centers -->
    <div class="col-md-4 mb-4">
      <div class="card  border-success h-100">
        <div class="card-header d-flex justify-content-start align-items-center bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-trophy me-2"></i>Most Used Work Centers
          </h6>
        </div>
        <div class="card-body">
          <% top_used = @operations_data.sort_by { |d| -d.operations_count }.first(5) %>
          <div class="list-group list-group-flush">
            <% top_used.each_with_index do |data, index| %>
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <% if index == 0 %>
                    <i class="fas fa-crown text-warning me-2"></i>
                  <% else %>
                    <span class="text-white badge bg-secondary me-2"><%= index + 1 %></span>
                  <% end %>
                  <strong><%= data.wc_code %></strong>
                  <br>
                  <small class="text-muted"><%= data.wc_name %></small>
                </div>
                <span class="text-white badge bg-success fs-6"><%= data.operations_count %> ops</span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Highest Labor Cost -->
    <div class="col-md-4 mb-4">
      <div class="card  border-primary h-100">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary text-white">
          <h6 class="mb-0">
            <i class="fas fa-users me-2"></i>Highest Labor Cost
          </h6>
        </div>
        <div class="card-body">
          <% top_labor = @operations_data.sort_by { |d| -d.total_labor_cost }.first(5) %>
          <div class="list-group list-group-flush">
            <% top_labor.each_with_index do |data, index| %>
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <span class="text-white badge bg-secondary me-2"><%= index + 1 %></span>
                  <strong><%= data.wc_code %></strong>
                  <br>
                  <small class="text-muted"><%= data.operations_count %> operations</small>
                </div>
                <span class="text-primary fw-bold">
                  $<%= number_with_precision(data.total_labor_cost, precision: 0) %>
                </span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Highest Overhead Cost -->
    <div class="col-md-4 mb-4">
      <div class="card  border-warning h-100">
        <div class="card-header d-flex justify-content-start align-items-center bg-warning text-dark">
          <h6 class="mb-0">
            <i class="fas fa-industry me-2"></i>Highest Overhead Cost
          </h6>
        </div>
        <div class="card-body">
          <% top_overhead = @operations_data.sort_by { |d| -d.total_overhead_cost }.first(5) %>
          <div class="list-group list-group-flush">
            <% top_overhead.each_with_index do |data, index| %>
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <span class="text-white badge bg-secondary me-2"><%= index + 1 %></span>
                  <strong><%= data.wc_code %></strong>
                  <br>
                  <small class="text-muted"><%= data.operations_count %> operations</small>
                </div>
                <span class="text-warning fw-bold">
                  $<%= number_with_precision(data.total_overhead_cost, precision: 0) %>
                </span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Average Metrics -->
  <div class="row">
    <div class="col-12">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>Average Metrics per Operation
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h6 class="text-muted mb-2">Avg Setup Time</h6>
                <h3 class="text-primary mb-0">
                  <%= number_with_precision(@operations_data.sum(&:total_setup) / @operations_data.sum(&:operations_count), precision: 1) %>
                </h3>
                <small class="text-muted">minutes per operation</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h6 class="text-muted mb-2">Avg Run Time</h6>
                <h3 class="text-info mb-0">
                  <%= number_with_precision(@operations_data.sum { |d| d.avg_run_time * d.operations_count } / @operations_data.sum(&:operations_count), precision: 1) %>
                </h3>
                <small class="text-muted">minutes per unit</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h6 class="text-muted mb-2">Avg Labor Cost</h6>
                <h3 class="text-warning mb-0">
                  $<%= number_with_precision(@operations_data.sum(&:total_labor_cost) / @operations_data.sum(&:operations_count), precision: 2) %>
                </h3>
                <small class="text-muted">per operation</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border rounded p-3">
                <h6 class="text-muted mb-2">Avg Total Cost</h6>
                <h3 class="text-success mb-0">
                  $<%= number_with_precision((@operations_data.sum(&:total_labor_cost) + @operations_data.sum(&:total_overhead_cost)) / @operations_data.sum(&:operations_count), precision: 2) %>
                </h3>
                <small class="text-muted">per operation</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Insights -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card  border-info">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>Key Insights
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-primary mb-3">
                <i class="fas fa-check-circle me-2"></i>Strengths
              </h6>
              <ul class="list-unstyled">
                <% if @operations_data.any? %>
                  <% most_efficient = @operations_data.min_by { |d| d.total_labor_cost / d.operations_count } %>
                  <li class="mb-2">
                    <i class="fas fa-star text-warning me-2"></i>
                    <strong><%= most_efficient.wc_code %></strong> has the lowest average labor cost 
                    ($<%= number_with_precision(most_efficient.total_labor_cost / most_efficient.operations_count, precision: 2) %>/operation)
                  </li>
                  
                  <% fastest_setup = @operations_data.min_by { |d| d.total_setup / d.operations_count } %>
                  <li class="mb-2">
                    <i class="fas fa-tachometer-alt text-success me-2"></i>
                    <strong><%= fastest_setup.wc_code %></strong> has the fastest average setup time 
                    (<%= number_with_precision(fastest_setup.total_setup / fastest_setup.operations_count, precision: 1) %> min)
                  </li>
                  
                  <% most_utilized = @operations_data.max_by(&:operations_count) %>
                  <li class="mb-2">
                    <i class="fas fa-fire text-danger me-2"></i>
                    <strong><%= most_utilized.wc_code %></strong> is your most utilized work center 
                    with <%= most_utilized.operations_count %> operations
                  </li>
                <% end %>
              </ul>
            </div>
            
            <div class="col-md-6">
              <h6 class="text-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>Opportunities
              </h6>
              <ul class="list-unstyled">
                <% underutilized = @operations_data.select { |d| d.operations_count < 3 } %>
                <% if underutilized.any? %>
                  <li class="mb-2">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <%= underutilized.count %> work centers have less than 3 operations - 
                    consider consolidating or reviewing capacity
                  </li>
                <% end %>
                
                <% expensive_labor = @operations_data.select { |d| (d.total_labor_cost / d.operations_count) > 10 } %>
                <% if expensive_labor.any? %>
                  <li class="mb-2">
                    <i class="fas fa-dollar-sign text-warning me-2"></i>
                    <%= expensive_labor.count %> work centers have average labor cost > $10/operation - 
                    review for optimization opportunities
                  </li>
                <% end %>
                
                <li class="mb-2">
                  <i class="fas fa-balance-scale text-primary me-2"></i>
                  Consider balancing operations across work centers to optimize utilization and reduce bottlenecks
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Pie Chart - Operations Distribution
  const pieCtx = document.getElementById('operationsDistributionChart').getContext('2d');
  
  const workCenters = <%= raw @operations_data.map(&:wc_code).to_json %>;
  const operationsCounts = <%= raw @operations_data.map(&:operations_count).to_json %>;
  
  // Generate colors
  const colors = workCenters.map((_, i) => {
    const hue = (i * 360 / workCenters.length);
    return `hsla(${hue}, 70%, 60%, 0.8)`;
  });
  
  const borderColors = workCenters.map((_, i) => {
    const hue = (i * 360 / workCenters.length);
    return `hsla(${hue}, 70%, 50%, 1)`;
  });
  
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: workCenters,
      datasets: [{
        data: operationsCounts,
        backgroundColor: colors,
        borderColor: borderColors,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + context.parsed + ' ops (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  
  // Bar Chart - Cost Distribution
  const barCtx = document.getElementById('costDistributionChart').getContext('2d');
  
  const laborCosts = <%= raw @operations_data.map(&:total_labor_cost).to_json %>;
  const overheadCosts = <%= raw @operations_data.map(&:total_overhead_cost).to_json %>;
  
  new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: workCenters,
      datasets: [
        {
          label: 'Labor Cost',
          data: laborCosts,
          backgroundColor: 'rgba(13, 110, 253, 0.6)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 2
        },
        {
          label: 'Overhead Cost',
          data: overheadCosts,
          backgroundColor: 'rgba(255, 193, 7, 0.6)',
          borderColor: 'rgba(255, 193, 7, 1)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          stacked: true
        },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value;
            }
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
            }
          }
        }
      }
    }
  });
});
</script>