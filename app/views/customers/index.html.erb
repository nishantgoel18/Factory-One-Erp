<%# app/views/customers/index.html.erb %>

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Customers</h2>

    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <%= link_to raw('<i class="anticon anticon-home m-r-5"></i>Home'), root_path, class: "breadcrumb-item" %>
        <%= link_to "Sales", "#", class: "breadcrumb-item" %>
        <span class="breadcrumb-item active">Customers</span>
      </nav>
    </div>
  </div>

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">
        <i class="bi bi-people-fill me-2"></i>
        Customers
      </h1>
      <p class="text-muted mb-0">Manage your customer relationships</p>
    </div>
    <div>
      <%= link_to new_customer_path, class: "btn btn-primary" do %>
        <i class="bi bi-plus-circle me-2"></i>New Customer
      <% end %>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-3 mb-4">

    <!-- TOTAL CUSTOMERS -->
    <div class="col-md-3">
      <div class="card ">
        <div class="card-body">
          <div class="media align-items-center">

            <div class="avatar avatar-icon avatar-lg avatar-blue">
              <i class="fa fa-users"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= @stats[:total] %></h2>
              <p class="m-b-0 text-muted">
                Total Customers
                <br>
                <span class="text-success"><%= @stats[:active] %> active</span>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- REVENUE YTD -->
    <div class="col-md-3">
      <div class="card ">
        <div class="card-body">
          <div class="media align-items-center">

            <div class="avatar avatar-icon avatar-lg avatar-green">
              <i class="anticon anticon-dollar"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= number_to_currency(@stats[:total_revenue_ytd]) %></h2>
              <p class="m-b-0 text-muted">
                Revenue YTD
                <br>
                Avg: <%= number_to_currency(@stats[:avg_order_value]) %>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- HIGH VALUE CUSTOMERS -->
    <div class="col-md-3">
      <div class="card ">
        <div class="card-body">
          <div class="media align-items-center">

            <div class="avatar avatar-icon avatar-lg avatar-blue">
              <i class="anticon anticon-star"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= @stats[:high_value] %></h2>
              <p class="m-b-0 text-muted">
                High Value
                <br>
                Category A: <%= @stats[:category_a] %>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- NEED ATTENTION -->
    <div class="col-md-3">
      <div class="card ">
        <div class="card-body">
          <div class="media align-items-center">

            <div class="avatar avatar-icon avatar-lg avatar-gold">
              <i class="fa fa-exclamation-triangle"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= @stats[:credit_hold] + @stats[:no_recent_orders] %></h2>
              <p class="m-b-0 text-muted">
                Need Attention
                <br>
                <span class="text-danger"><%= @stats[:credit_hold] %> on hold</span>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Filters & Search -->
  <div class="card border-0  mb-4">
    <div class="card-body">
      <%= form_with url: customers_path, method: :get, local: true, class: "row g-3" do |f| %>
        <!-- Search -->
        <div class="col-md-4">
          <label class="form-label small text-muted">Search</label>
          <%= f.text_field :search, 
                          value: params[:search], 
                          class: "form-control", 
                          placeholder: "Search by name, code, or email..." %>
        </div>

        <!-- Status Filter -->
        <div class="col-md-2">
          <label class="form-label small text-muted">Status</label>
          <%= f.select :status, 
                      options_for_select([
                        ['All', ''],
                        ['Active', 'active'],
                        ['Inactive', 'inactive'],
                        ['Credit Hold', 'credit_hold']
                      ], params[:status]),
                      {}, 
                      class: "form-control" %>
        </div>

        <!-- Category Filter -->
        <div class="col-md-2">
          <label class="form-label small text-muted">Category</label>
          <%= f.select :category,
                      options_for_select([['All', '']] + @categories.to_a, params[:category]),
                      {},
                      class: "form-control" %>
        </div>

        <!-- Type Filter -->
        <div class="col-md-2">
          <label class="form-label small text-muted">Type</label>
          <%= f.select :type,
                      options_for_select([['All', '']] + @types.to_a, params[:type]),
                      {},
                      class: "form-control" %>
        </div>

        <!-- Actions -->
        <div class="col-md-2">
          <label class="form-label small text-muted">&nbsp;</label>
          <div class="d-grid gap-2">
            <%= f.submit "Filter", class: "btn btn-primary" %>
          </div>
        </div>

        <!-- Advanced Filters Toggle -->
        <div class="col-12">
          <button type="button" class="btn btn-sm btn-link" data-toggle="collapse" data-target="#advancedFilters">
            <i class="bi bi-funnel me-1"></i>Advanced Filters
          </button>
        </div>

        <!-- Advanced Filters (Collapsed) -->
        <div class="collapse" id="advancedFilters">
          <div class="row g-3 border-top pt-3">
            <div class="col-md-3">
              <label class="form-label small text-muted">Sales Rep</label>
              <%= f.select :sales_rep_id,
                          options_for_select([['All', '']] + @sales_reps.map { |r| [r.email, r.id] }, params[:sales_rep_id]),
                          {},
                          class: "form-control" %>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Territory</label>
              <%= f.text_field :territory, value: params[:territory], class: "form-control" %>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Activity</label>
              <%= f.select :activity,
                          options_for_select([
                            ['All', ''],
                            ['Recent Orders', 'recent_orders'],
                            ['No Recent Orders', 'no_recent_orders']
                          ], params[:activity]),
                          {},
                          class: "form-control" %>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Min Revenue</label>
              <%= f.number_field :min_revenue, value: params[:min_revenue], class: "form-control", placeholder: "0" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <%= form_with url: bulk_action_customers_path, method: :post, id: "bulkActionForm" do %>
    <div class="card border-0  mb-3" id="bulkActionBar" style="display: none;">
      <div class="card-body py-2">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="fw-bold"><span id="selectedCount">0</span> selected</span>
          </div>
          <div class="col-auto">
            <select name="bulk_action_type" class="form-control form-control-sm">
              <option value="">Choose action...</option>
              <option value="activate">Activate</option>
              <option value="deactivate">Deactivate</option>
              <option value="export">Export Selected</option>
              <option value="delete">Delete</option>
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
          </div>
          <div class="col-auto">
            <button type="button" class="btn btn-sm btn-link" onclick="clearSelection()">Clear Selection</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Customer Table -->
  <div class="card border-0 ">
    <div class="card-header bg-info border-bottom d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Customer List</h5>
      <div class="btn-group btn-group-sm">
        <%= link_to customers_path(format: :csv), class: "btn btn-success" do %>
          <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export CSV
        <% end %>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table mb-0" id="customersTable">
          <thead class="table">
            <tr>
              <th width="40">
                <input type="checkbox" id="selectAll" class="form-check-input">
              </th>
              <th>Code</th>
              <th>Customer Name</th>
              <th>Category</th>
              <th>Contact</th>
              <th>Location</th>
              <th class="text-end">Credit Limit</th>
              <th class="text-end">Balance</th>
              <th class="text-end">Revenue YTD</th>
              <th>Last Order</th>
              <th>Status</th>
              <th width="100">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if @customers.any? %>
              <% @customers.each do |customer| %>
                <tr>
                  <td>
                    <input type="checkbox" name="customer_ids[]" value="<%= customer.id %>" class="form-check-input customer-checkbox">
                  </td>
                  <td>
                    <span class="badge bg-info text-dark font-monospace"><%= customer.code %></span>
                  </td>
                  <td>
                    <%= link_to customer_path(customer), class: "text-decoration-none fw-bold" do %>
                      <%= customer.display_name %>
                    <% end %>
                    <% if customer.credit_hold? %>
                      <i class="bi bi-exclamation-triangle-fill text-danger ms-1" title="Credit Hold"></i>
                    <% end %>
                  </td>
                  <td>
                    <span class="badge bg-<%= customer.category_badge_class %>">
                      <%= customer.customer_category || 'NEW' %>
                    </span>
                  </td>
                  <td>
                    <% if customer.primary_contact %>
                      <div class="small">
                        <i class="bi bi-person me-1"></i><%= customer.primary_contact.full_name %>
                      </div>
                      <div class="text-muted small">
                        <i class="bi bi-envelope me-1"></i><%= customer.primary_contact.email %>
                      </div>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="small">
                      <%= customer.billing_city %><%= ", #{customer.billing_state}" if customer.billing_state.present? %>
                    </div>
                  </td>
                  <td class="text-end">
                    <%= number_to_currency(customer.credit_limit) %>
                  </td>
                  <td class="text-end">
                    <span class="<%= 'text-danger' if customer.over_credit_limit? %>">
                      <%= number_to_currency(customer.current_balance) %>
                    </span>
                  </td>
                  <td class="text-end">
                    <%= number_to_currency(customer.total_revenue_ytd) %>
                  </td>
                  <td>
                    <% if customer.last_order_date %>
                      <%= customer.last_order_date.strftime("%m/%d/%Y") %>
                    <% else %>
                      <span class="text-muted">No orders</span>
                    <% end %>
                  </td>
                  <td>
                    <span class="badge bg-<%= customer.status_badge_class %>">
                      <%= customer.status_label %>
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <%= link_to customer_path(customer), class: "btn btn-outline-primary", title: "View" do %>
                        View
                      <% end %>
                      <%= link_to edit_customer_path(customer), class: "btn btn-outline-secondary", title: "Edit" do %>
                        Edit
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="12" class="text-center py-5">
                  <i class="bi bi-inbox display-4 text-muted"></i>
                  <p class="mt-3 text-muted">No customers found</p>
                  <%= link_to "Create your first customer", new_customer_path, class: "btn btn-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Pagination -->
    <% if @customers.any? %>
      <div class="card-footer bg-white border-top">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            Showing <%= @customers.offset_value + 1 %> to <%= [@customers.offset_value + @customers.length, @customers.total_count].min %> of <%= @customers.total_count %> customers
          </div>
          <div>
            <%== pagy_bootstrap_nav(@pagy) if defined?(@pagy) %>
            <%== paginate @customers if defined?(paginate) %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- JavaScript for bulk actions -->
<script>
  // Select All functionality
  document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.customer-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActionBar();
  });

  // Individual checkbox
  document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActionBar);
  });

  function updateBulkActionBar() {
    const selected = document.querySelectorAll('.customer-checkbox:checked').length;
    const bar = document.getElementById('bulkActionBar');
    const count = document.getElementById('selectedCount');
    
    if (selected > 0) {
      bar.style.display = 'block';
      count.textContent = selected;
    } else {
      bar.style.display = 'none';
    }
  }

  function clearSelection() {
    document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateBulkActionBar();
  }
</script>
