<%= form_with model: document, url: document.new_record? ? customer_documents_path(customer) : customer_document_path(customer, document),
              method: document.new_record? ? :post : :patch,
              id: "documentForm",
              data: { remote: true },
              multipart: true do |f| %>

  <div class="modal-header">
    <h5 class="modal-title">
      <i class="bi bi-file-earmark-arrow-up me-2"></i>
      <%= document.new_record? ? "Upload Document" : "Edit Document" %>
    </h5>
  </div>

  <div class="modal-body">
    <!-- Error Messages -->
    <div id="documentFormErrors" class="alert alert-danger d-none"></div>

    <div class="row g-3">
      <!-- Document Type -->
      <div class="col-md-6">
        <%= f.label :document_type, "Document Type *", class: "form-label" %>
        <%= f.select :document_type,
                    options_for_select([
                      ['Contract/Agreement', 'CONTRACT'],
                      ['Tax Certificate', 'TAX_CERT'],
                      ['NDA', 'NDA'],
                      ['Credit Application', 'CREDIT_APP'],
                      ['Quality Agreement', 'QUALITY_AGREEMENT'],
                      ['Insurance Certificate', 'INSURANCE_CERT'],
                      ['Business License', 'BUSINESS_LICENSE'],
                      ['W-9 Form', 'W9_FORM'],
                      ['Other', 'OTHER']
                    ], document.document_type),
                    { include_blank: "Select type..." },
                    class: "form-control",
                    required: true %>
      </div>

      <!-- Document Category -->
      <div class="col-md-6">
        <%= f.label :document_category, "Category", class: "form-label" %>
        <%= f.select :document_category,
                    options_for_select([
                      ['Legal', 'LEGAL'],
                      ['Financial', 'FINANCIAL'],
                      ['Quality', 'QUALITY'],
                      ['Compliance', 'COMPLIANCE'],
                      ['General', 'GENERAL']
                    ], document.document_category),
                    { include_blank: "Select category..." },
                    class: "form-control" %>
      </div>

      <!-- Document Title -->
      <div class="col-12">
        <%= f.label :document_title, "Document Title *", class: "form-label" %>
        <%= f.text_field :document_title, class: "form-control", required: true,
                        placeholder: "Enter descriptive title" %>
      </div>

      <!-- Description -->
      <div class="col-12">
        <%= f.label :description, "Description", class: "form-label" %>
        <%= f.text_area :description, class: "form-control", rows: 2,
                       placeholder: "Brief description of the document..." %>
      </div>

      <!-- File Upload -->
      <div class="col-12">
        <%= f.label :file, "Upload File", class: "form-label" %>
        <%= f.file_field :file, class: "form-control", accept: ".pdf,.doc,.docx,.jpg,.jpeg,.png" %>
        <div class="form-text">Accepted: PDF, Word, Images (Max 10MB)</div>
        <% if document.file_attached? %>
          <div class="alert alert-info mt-2 mb-0">
            <i class="bi bi-paperclip me-1"></i>
            Current file: <strong><%= document.file_name %></strong>
            (<%= number_to_human_size(document.file_size) %>)
          </div>
        <% end %>
      </div>

      <!-- Divider -->
      <div class="col-12">
        <hr class="my-2">
        <h6 class="text-muted">Validity Dates</h6>
      </div>

      <!-- Effective Date -->
      <div class="col-md-6">
        <%= f.label :effective_date, "Effective Date", class: "form-label" %>
        <%= f.date_field :effective_date, class: "form-control" %>
      </div>

      <!-- Expiry Date -->
      <div class="col-md-6">
        <%= f.label :expiry_date, "Expiry Date", class: "form-label" %>
        <%= f.date_field :expiry_date, class: "form-control" %>
      </div>

      <!-- Renewal Options -->
      <div class="col-md-6">
        <div class="form-check mt-4">
          <%= f.check_box :requires_renewal, class: "form-check-input" %>
          <%= f.label :requires_renewal, "Requires Renewal", class: "form-check-label" %>
        </div>
      </div>

      <div class="col-md-6" id="renewalDaysField" style="<%= 'display: none;' unless document.requires_renewal? %>">
        <%= f.label :renewal_reminder_days, "Remind Days Before", class: "form-label" %>
        <%= f.number_field :renewal_reminder_days, class: "form-control", value: 30, min: 1 %>
      </div>

      <!-- Divider -->
      <div class="col-12">
        <hr class="my-2">
        <h6 class="text-muted">Additional Options</h6>
      </div>

      <!-- Version -->
      <div class="col-md-6">
        <%= f.label :version, "Version Number", class: "form-label" %>
        <%= f.number_field :version, class: "form-control", min: 1, step: 1 %>
      </div>

      <!-- Status & Access -->
      <div class="col-md-6">
        <label class="form-label">&nbsp;</label>
        <div>
          <div class="form-check">
            <%= f.check_box :is_confidential, class: "form-check-input" %>
            <%= f.label :is_confidential, "Confidential", class: "form-check-label" %>
          </div>
          <div class="form-check">
            <%= f.check_box :customer_can_view, class: "form-check-input" %>
            <%= f.label :customer_can_view, "Customer Can View", class: "form-check-label" %>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="col-12">
        <%= f.label :notes, "Internal Notes", class: "form-label" %>
        <%= f.text_area :notes, class: "form-control", rows: 2,
                       placeholder: "Internal notes (not visible to customer)..." %>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
    <%= f.submit document.new_record? ? "Upload Document" : "Update Document",
                class: "btn btn-primary",
                data: { disable_with: "Uploading..." } %>
  </div>
<% end %>

<script>
  // Toggle renewal reminder field
  document.getElementById('customer_document_requires_renewal')?.addEventListener('change', function() {
    document.getElementById('renewalDaysField').style.display = this.checked ? 'block' : 'none';
  });

  // Handle form submission via AJAX
  document.getElementById('documentForm').addEventListener('ajax:success', function(event) {
    const [data, status, xhr] = event.detail;
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('dynamicModal')).hide();
    
    // Show success message
    showNotification('success', data.message || 'Document saved successfully');
    
    // Reload documents list
    reloadDocumentsList();
  });

  document.getElementById('documentForm').addEventListener('ajax:error', function(event) {
    const [data, status, xhr] = event.detail;
    
    // Show errors
    const errorDiv = document.getElementById('documentFormErrors');
    errorDiv.classList.remove('d-none');
    errorDiv.innerHTML = '<ul class="mb-0">' +
                        data.errors.map(err => '<li>' + err + '</li>').join('') +
                        '</ul>';
  });
</script>