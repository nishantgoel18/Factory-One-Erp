<%# app/views/customers/show.html.erb %>

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Customer Details</h2>

    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <%= link_to raw('<i class="anticon anticon-home m-r-5"></i>Home'), root_path, class: "breadcrumb-item" %>
        <%= link_to "Sales", "#", class: "breadcrumb-item" %>
        <%= link_to "Customers", customers_path, class: "breadcrumb-item" %>
        <span class="breadcrumb-item active">Customer Details</span>
      </nav>
    </div>
  </div>

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <div class="d-flex align-items-center gap-2 mb-2">
        <%= link_to customers_path, class: "btn btn-sm btn-outline-secondary" do %>
          <i class="anticon anticon-arrow-left"></i>
        <% end %>
        <h1 class="h3 mb-0"><%= @customer.display_name %></h1>
        <span class="badge bg-<%= @customer.status_badge_class %> fs-6">
          <%= @customer.status_label %>
        </span>
        <span class="badge bg-<%= @customer.category_badge_class %> fs-6">
          <%= @customer.customer_category %>
        </span>
      </div>
      <div class="text-muted small">
        Customer Code: <span class="font-monospace fw-bold"><%= @customer.code %></span>
        <% if @customer.customer_since %>
          | Customer Since: <%= @customer.customer_since.strftime("%B %Y") %>
        <% end %>
      </div>
    </div>
    
    <div class="btn-group">
      <%= link_to edit_customer_path(@customer), class: "btn btn-outline-primary" do %>
        <i class="anticon anticon-pencil me-1"></i>Edit
      <% end %>
      <%= link_to statement_customer_path(@customer, format: :pdf), class: "btn btn-outline-secondary", target: "_blank" do %>
        <i class="anticon anticon-file-pdf me-1"></i>Statement
      <% end %>
      <%= link_to dashboard_customer_path(@customer), class: "btn btn-outline-info" do %>
        <i class="anticon anticon-graph me-1"></i>Analytics
      <% end %>
      <% if @customer.credit_hold? %>
        <%= link_to credit_hold_customer_path(@customer, action_type: "remove"), method: :post, class: "btn btn-outline-info", data: { confirm: "Remove credit hold?" } do %>
          <i class="bi bi-check-circle me-2"></i>Remove Credit Hold
        <% end %>
      <% else %>
        <%= link_to "#", class: "btn btn-outline-info", data: { bs_toggle: "modal", bs_target: "#creditHoldModal" } do %>
          <i class="bi bi-ban me-2"></i>Place Credit Hold
        <% end %>
      <% end %>
      <%= link_to delete_customer_path(@customer), method: :get, class: "btn btn-outline-danger", data: { confirm: "Are you sure?" } do %>
        <i class="bi bi-trash me-2"></i>Delete Customer
      <% end %>
      
    </div>
  </div>

  <!-- Alert Cards -->
  <% if @customer.credit_hold? %>
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
      <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
      <div>
        <strong>Credit Hold Active</strong><br>
        <span class="small"><%= @customer.credit_hold_reason %></span>
        <% if @customer.credit_hold_date %>
          <span class="small text-muted">| Since <%= @customer.credit_hold_date.strftime("%m/%d/%Y") %></span>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @customer.over_credit_limit? %>
    <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
      <i class="bi bi-exclamation-circle-fill fs-4 me-3"></i>
      <div>
        <strong>Over Credit Limit</strong><br>
        <span class="small">
          Balance: <%= number_to_currency(@customer.current_balance) %> | 
          Limit: <%= number_to_currency(@customer.credit_limit) %> | 
          Over by: <%= number_to_currency(@customer.current_balance - @customer.credit_limit) %>
        </span>
      </div>
    </div>
  <% end %>

  <% if @expiring_docs.any? %>
    <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
      <i class="bi bi-info-circle-fill fs-4 me-3"></i>
      <div>
        <strong><%= @expiring_docs.count %> Document(s) Expiring Soon</strong><br>
        <span class="small">Review and renew documents in the Documents tab</span>
      </div>
    </div>
  <% end %>

  <!-- Quick Stats Row -->
  <div class="row g-3 mb-1">

    <!-- CUSTOMER HEALTH -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="media align-items-center">

            <% color = @performance_data[:health_score] >= 80 ? 'green' : @performance_data[:health_score] >= 60 ? 'orange' : 'red' %>

            <div class="avatar avatar-icon avatar-lg avatar-<%= color %>">
              <i class="fa fa-heartbeat"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= @performance_data[:health_score] %>/100</h2>
              <p class="m-b-0 text-muted"><%= @performance_data[:health_label] %></p>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- TOTAL REVENUE -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="media align-items-center">

            <div class="avatar avatar-icon avatar-lg avatar-green">
              <i class="anticon anticon-dollar"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0">
                <%= number_to_currency(@performance_data[:total_revenue]) %>
              </h2>
              <p class="m-b-0 text-muted">
                YTD: <%= number_to_currency(@performance_data[:revenue_ytd]) %>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- ORDERS & AVERAGE -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="media align-items-center">

            <div class="avatar avatar-icon avatar-lg avatar-blue">
              <i class="fa fa-shopping-cart"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= @performance_data[:total_orders] %></h2>
              <p class="m-b-0 text-muted">
                Avg: <%= number_to_currency(@performance_data[:avg_order_value]) %>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>


    <!-- PAYMENT PERFORMANCE -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="media align-items-center">

            <% pay_color = @performance_data[:on_time_payment_rate] >= 95 ? 'green' : 'orange' %>

            <div class="avatar avatar-icon avatar-lg avatar-<%= pay_color %>">
              <i class="fa fa-check-circle"></i>
            </div>

            <div class="m-l-15">
              <h2 class="m-b-0"><%= @performance_data[:on_time_payment_rate].to_f.round %>%</h2>
              <p class="m-b-0 text-muted">
                <%= @performance_data[:payment_performance] %>
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Main Content with Tabs -->
  <div class="card border">
    <!-- Tab Navigation -->
    <div class="card-header bg-white border-bottom">
      <ul class="nav nav-tabs card-header-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-toggle="tab" href="#overview" role="tab">
            <i class="bi bi-info-circle me-1"></i>Overview
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#addresses" role="tab">
            <i class="bi bi-geo-alt me-1"></i>
            Addresses
            <span class="badge bg-secondary ms-1"><%= @customer.addresses.count %></span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#contacts" role="tab">
            <i class="bi bi-person me-1"></i>
            Contacts
            <span class="badge bg-secondary ms-1"><%= @customer.contacts.count %></span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#documents" role="tab">
            <i class="bi bi-file-earmark me-1"></i>
            Documents
            <span class="badge bg-secondary ms-1"><%= @customer.documents.count %></span>
            <% if @expiring_docs.any? %>
              <i class="bi bi-exclamation-circle-fill text-warning ms-1"></i>
            <% end %>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#activities" role="tab">
            <i class="bi bi-activity me-1"></i>
            Activities
            <span class="badge bg-secondary ms-1"><%= @customer.activities.count %></span>
            <% if @pending_followups.any? %>
              <span class="badge bg-danger ms-1"><%= @pending_followups.count %></span>
            <% end %>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#orders" role="tab">
            <i class="bi bi-cart me-1"></i>Orders
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#financial" role="tab">
            <i class="bi bi-cash me-1"></i>Financial
          </a>
        </li>
      </ul>
    </div>

    <!-- Tab Content -->
    <div class="card-body">
      <div class="tab-content">
        
        <!-- OVERVIEW TAB -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
              <h5 class="mb-3">Basic Information</h5>
              <table class="table table-sm">
                <tr>
                  <th width="180">Full Name:</th>
                  <td><%= @customer.full_name %></td>
                </tr>
                <% if @customer.legal_name.present? %>
                  <tr>
                    <th>Legal Name:</th>
                    <td><%= @customer.legal_name %></td>
                  </tr>
                <% end %>
                <% if @customer.dba_name.present? %>
                  <tr>
                    <th>DBA:</th>
                    <td><%= @customer.dba_name %></td>
                  </tr>
                <% end %>
                <tr>
                  <th>Type:</th>
                  <td><%= Customer::CUSTOMER_TYPES[@customer.customer_type] %></td>
                </tr>
                <tr>
                  <th>Category:</th>
                  <td>
                    <span class="badge bg-<%= @customer.category_badge_class %>">
                      <%= Customer::CUSTOMER_CATEGORIES[@customer.customer_category] %>
                    </span>
                  </td>
                </tr>
                <% if @customer.industry_type.present? %>
                  <tr>
                    <th>Industry:</th>
                    <td><%= @customer.industry_type %></td>
                  </tr>
                <% end %>
              </table>

              <h5 class="mt-4 mb-3">Contact Information</h5>
              <table class="table table-sm">
                <% if @customer.email.present? %>
                  <tr>
                    <th width="180">Email:</th>
                    <td><%= mail_to @customer.email %></td>
                  </tr>
                <% end %>
                <% if @customer.phone_number.present? %>
                  <tr>
                    <th>Phone:</th>
                    <td><%= @customer.phone_number %></td>
                  </tr>
                <% end %>
                <% if @customer.mobile.present? %>
                  <tr>
                    <th>Mobile:</th>
                    <td><%= @customer.mobile %></td>
                  </tr>
                <% end %>
                <% if @customer.website.present? %>
                  <tr>
                    <th>Website:</th>
                    <td><%= link_to @customer.website, @customer.website, target: "_blank" %></td>
                  </tr>
                <% end %>
              </table>

              <% if @customer.primary_address %>
                <h5 class="mt-4 mb-3">Primary Address</h5>
                <address class="mb-0">
                  <%= simple_format(@customer.primary_address.full_address) %>
                </address>
              <% end %>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
              <h5 class="mb-3">Financial Information</h5>
              <table class="table table-sm">
                <tr>
                  <th width="180">Credit Limit:</th>
                  <td><%= number_to_currency(@customer.credit_limit) %></td>
                </tr>
                <tr>
                  <th>Current Balance:</th>
                  <td class="<%= 'text-danger fw-bold' if @customer.over_credit_limit? %>">
                    <%= number_to_currency(@customer.current_balance) %>
                  </td>
                </tr>
                <tr>
                  <th>Available Credit:</th>
                  <td class="<%= 'text-success' unless @customer.over_credit_limit? %>">
                    <%= number_to_currency(@customer.available_credit) %>
                  </td>
                </tr>
                <tr>
                  <th>Credit Utilization:</th>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-<%= @performance_data[:credit_utilization] > 90 ? 'danger' : @performance_data[:credit_utilization] > 75 ? 'warning' : 'success' %>" 
                           style="width: <%= [@performance_data[:credit_utilization], 100].min %>%">
                        <%= @performance_data[:credit_utilization].round %>%
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <th>Payment Terms:</th>
                  <td><%= Customer::PAYMENT_TERMS[@customer.payment_terms] %></td>
                </tr>
              </table>

              <h5 class="mt-4 mb-3">Sales Information</h5>
              <table class="table table-sm">
                <% if @customer.default_sales_rep %>
                  <tr>
                    <th width="180">Sales Rep:</th>
                    <td><%= @customer.default_sales_rep.email %></td>
                  </tr>
                <% end %>
                <% if @customer.sales_territory.present? %>
                  <tr>
                    <th>Territory:</th>
                    <td><%= @customer.sales_territory %></td>
                  </tr>
                <% end %>
                <% if @customer.customer_acquisition_source.present? %>
                  <tr>
                    <th>Acquisition Source:</th>
                    <td><%= Customer::ACQUISITION_SOURCES[@customer.customer_acquisition_source] %></td>
                  </tr>
                <% end %>
                <tr>
                  <th>Last Order:</th>
                  <td>
                    <% if @customer.last_order_date %>
                      <%= @customer.last_order_date.strftime("%m/%d/%Y") %>
                      (<%= time_ago_in_words(@customer.last_order_date) %> ago)
                    <% else %>
                      <span class="text-muted">No orders yet</span>
                    <% end %>
                  </td>
                </tr>
              </table>

              <% if @pending_followups.any? %>
                <div class="alert alert-warning mt-4">
                  <h6 class="alert-heading">
                    <i class="bi bi-bell-fill me-2"></i>Pending Follow-ups
                  </h6>
                  <ul class="mb-0">
                    <% @pending_followups.limit(3).each do |followup| %>
                      <li>
                        <%= followup.subject %> - 
                        <span class="text-danger"><%= followup.followup_date.strftime("%m/%d/%Y") %></span>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- ADDRESSES TAB -->
        <div class="tab-pane fade" id="addresses" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Addresses</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addAddress()">
              <i class="bi bi-plus-circle me-1"></i>Add Address
            </button>
          </div>
          <div id="addressesList">
            <%= render partial: "customers/addresses/list", locals: { customer: @customer } %>
          </div>
        </div>

        <!-- CONTACTS TAB -->
        <div class="tab-pane fade" id="contacts" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Contacts</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addContact()">
              <i class="bi bi-plus-circle me-1"></i>Add Contact
            </button>
          </div>
          <div id="contactsList">
            <%= render partial: "customers/contacts/list", locals: { customer: @customer } %>
          </div>
        </div>

        <!-- DOCUMENTS TAB -->
        <div class="tab-pane fade" id="documents" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Documents</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addDocument()">
              <i class="bi bi-plus-circle me-1"></i>Upload Document
            </button>
          </div>
          <div id="documentsList">
            <%= render partial: "customers/documents/list", locals: { customer: @customer } %>
          </div>
        </div>

        <!-- ACTIVITIES TAB -->
        <div class="tab-pane fade" id="activities" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Activity History</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addActivity()">
              <i class="bi bi-plus-circle me-1"></i>Log Activity
            </button>
          </div>
          <div id="activitiesList">
            <%= render partial: "customers/activities/list", locals: { customer: @customer } %>
          </div>
        </div>

        <!-- ORDERS TAB (Placeholder) -->
        <div class="tab-pane fade" id="orders" role="tabpanel">
          <h5 class="mb-3">Sales Orders</h5>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Sales order history will appear here once integrated with Sales Order module.
          </div>
        </div>

        <!-- FINANCIAL TAB (Placeholder) -->
        <div class="tab-pane fade" id="financial" role="tabpanel">
          <h5 class="mb-3">Financial Summary</h5>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Invoice history and payment details will appear here once integrated with Accounting module.
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Credit Hold Modal -->
<div class="modal fade" id="creditHoldModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: credit_hold_customer_path(@customer), method: :post do |f| %>
        <%= hidden_field_tag :action_type, "place" %>
        <div class="modal-header">
          <h5 class="modal-title">Place Credit Hold</h5>
          <button type="button" class="btn-close" data-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Reason for Credit Hold *</label>
            <%= text_area_tag :reason, nil, class: "form-control", rows: 3, required: true, 
                             placeholder: "Enter reason for placing customer on credit hold..." %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <%= f.submit "Place Credit Hold", class: "btn btn-danger" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Modal Container for AJAX forms -->
<div class="modal fade" id="dynamicModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="modalContent">
      <!-- Content loaded via AJAX -->
    </div>
  </div>
</div>

<script>
  // Functions for adding nested resources (will be implemented with JavaScript)
  function addAddress() {
    // Load form via AJAX
    fetch('<%= new_customer_address_path(@customer) %>')
      .then(response => response.text())
      .then(html => {
        document.getElementById('modalContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('dynamicModal')).show();
      });
  }

  function addContact() {
    fetch('<%= new_customer_contact_path(@customer) %>')
      .then(response => response.text())
      .then(html => {
        document.getElementById('modalContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('dynamicModal')).show();
      });
  }

  function addDocument() {
    fetch('<%= new_customer_document_path(@customer) %>')
      .then(response => response.text())
      .then(html => {
        document.getElementById('modalContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('dynamicModal')).show();
      });
  }

  function addActivity() {
    fetch('<%= new_customer_activity_path(@customer) %>')
      .then(response => response.text())
      .then(html => {
        document.getElementById('modalContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('dynamicModal')).show();
      });
  }
</script>
