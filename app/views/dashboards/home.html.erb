
<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="container-fluid">
    <!-- Welcome Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold mb-1">
        ðŸ‘‹ Welcome back, <%= current_user.full_name %>!
      </h2>
      <p class="text-muted mb-0">
        <%= current_organization.name %> Dashboard
        <% if current_org_setting %>
          Â· <%= current_org_setting.format_date(Date.current) %>
        <% end %>
      </p>
    </div>
  </div>

  <!-- Setup Progress Alert (if not complete) -->
  <% unless current_organization.setup_complete? %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <div class="d-flex align-items-center">
        <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
        <div class="flex-grow-1">
          <h5 class="alert-heading mb-1">Complete Your Setup</h5>
          <p class="mb-2">
            Your organization setup is <%= current_organization.setup_progress_percentage %>% complete.
            Finish setup to unlock the full potential of your ERP system.
          </p>
          <div class="progress mb-2" style="height: 20px;">
            <div class="progress-bar bg-success" role="progressbar" 
                 style="width: <%= current_organization.setup_progress_percentage %>%">
              <%= current_organization.setup_progress_percentage %>%
            </div>
          </div>
          <%= link_to "Continue Setup â†’", setup_wizard_path, class: "btn btn-sm btn-warning" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Quick Stats -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Products</h6>
              <h3 class="fw-bold mb-0"><%= current_organization.total_products %></h3>
            </div>
            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-box-seam fs-3 text-primary"></i>
            </div>
          </div>
          <%= link_to "View Products â†’", products_path, class: "btn btn-sm btn-outline-primary mt-3 w-100" %>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Active Work Orders</h6>
              <h3 class="fw-bold mb-0"><%= current_organization.work_orders.where(status: ['RELEASED', 'IN_PROGRESS']).count %></h3>
            </div>
            <div class="bg-success bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-gear-fill fs-3 text-success"></i>
            </div>
          </div>
          <%= link_to "View Work Orders â†’", work_orders_path, class: "btn btn-sm btn-outline-success mt-3 w-100" %>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Customers</h6>
              <h3 class="fw-bold mb-0"><%= current_organization.total_customers %></h3>
            </div>
            <div class="bg-info bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-people-fill fs-3 text-info"></i>
            </div>
          </div>
          <%= link_to "View Customers â†’", customers_path, class: "btn btn-sm btn-outline-info mt-3 w-100" %>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Suppliers</h6>
              <h3 class="fw-bold mb-0"><%= current_organization.total_suppliers %></h3>
            </div>
            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-truck fs-3 text-warning"></i>
            </div>
          </div>
          <%= link_to "View Suppliers â†’", suppliers_path, class: "btn btn-sm btn-outline-warning mt-3 w-100" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center bg-gradient-primary text-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-lightning-fill text-warning"></i> Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-2">
              <%= link_to new_work_order_path, class: "btn btn-outline-primary w-100" do %>
                <i class="bi bi-plus-circle"></i> New Work Order
              <% end %>
            </div>
            <div class="col-md-2">
              <%= link_to new_product_path, class: "btn btn-outline-success w-100" do %>
                <i class="bi bi-plus-circle"></i> New Product
              <% end %>
            </div>
            <div class="col-md-2">
              <%= link_to new_rfq_path, class: "btn btn-outline-info w-100" do %>
                <i class="bi bi-plus-circle"></i> New RFQ
              <% end %>
            </div>
            <div class="col-md-2">
              <%= link_to new_inventory_purchase_order_path, class: "btn btn-outline-warning w-100" do %>
                <i class="bi bi-plus-circle"></i> New PO
              <% end %>
            </div>
            <div class="col-md-2">
              <%= link_to new_customer_path, class: "btn btn-outline-secondary w-100" do %>
                <i class="bi bi-plus-circle"></i> New Customer
              <% end %>
            </div>
            <div class="col-md-2">
              <%= link_to new_supplier_path, class: "btn btn-outline-dark w-100" do %>
                <i class="bi bi-plus-circle"></i> New Supplier
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity & Resources -->
  <div class="row">
    <!-- Recent Work Orders -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-gradient-primary text-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-clock-history text-primary"></i> Recent Work Orders
          </h5>
          <%= link_to "View All â†’", work_orders_path, class: "btn btn-sm btn-primary"%>
        </div>
        <div class="card-body">
          <% recent_work_orders = current_organization.work_orders.order(created_at: :desc).limit(5) %>
          <% if recent_work_orders.any? %>
            <div class="list-group list-group-flush">
              <% recent_work_orders.each do |wo| %>
                <div class="list-group-item px-0">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                      <%= link_to "WO ##{wo.work_order_number}", work_order_path(wo) %>
                    </h6>
                    <small class="text-muted"><%= time_ago_in_words(wo.created_at) %> ago</small>
                  </div>
                  <p class="mb-1 small">
                    <%= wo.product.name %> - Qty: <%= wo.quantity_to_produce %>
                  </p>
                  <span class="badge bg-<%= wo.status == 'COMPLETED' ? 'success' : 'warning' %>">
                    <%= wo.status %>
                  </span>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <p class="text-muted mt-3">No work orders yet</p>
              <%= link_to "Create Your First Work Order", new_work_order_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Getting Started / Resources -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-gradient-primary text-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-lightbulb text-warning"></i> Getting Started
          </h5>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            <div class="list-group-item px-0 border-0">
              <div class="d-flex align-items-start">
                <div class="me-3">
                  <i class="bi bi-1-circle-fill text-primary fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1">Set Up Master Data</h6>
                  <p class="text-muted small mb-2">Add products, work centers, and warehouses</p>
                  <%= link_to "Add Products â†’", products_path, class: "btn btn-sm btn-outline-primary" %>
                </div>
              </div>
            </div>

            <div class="list-group-item px-0 border-0">
              <div class="d-flex align-items-start">
                <div class="me-3">
                  <i class="bi bi-2-circle-fill text-success fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1">Create Bill of Materials</h6>
                  <p class="text-muted small mb-2">Define product recipes and components</p>
                  <%= link_to "Manage BOMs â†’", products_path, class: "btn btn-sm btn-outline-success" %>
                </div>
              </div>
            </div>

            <div class="list-group-item px-0 border-0">
              <div class="d-flex align-items-start">
                <div class="me-3">
                  <i class="bi bi-3-circle-fill text-info fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1">Add Your Team</h6>
                  <p class="text-muted small mb-2">Invite users and assign roles</p>
                  <% if can?(:manage_users) %>
                    <%= link_to "Manage Users â†’", settings_users_path, class: "btn btn-sm btn-outline-info" %>
                  <% end %>
                </div>
              </div>
            </div>

            <div class="list-group-item px-0 border-0">
              <div class="d-flex align-items-start">
                <div class="me-3">
                  <i class="bi bi-4-circle-fill text-warning fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1">Configure MRP Settings</h6>
                  <p class="text-muted small mb-2">Set planning horizons and policies</p>
                  <% if can?(:manage_settings) %>
                    <%= link_to "MRP Config â†’", settings_mrp_configuration_path, class: "btn btn-sm btn-outline-warning" %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Organization Info Footer -->
  <div class="row mt-1">
    <div class="col-12">
      <div class="card bg-white">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h6 class="mb-1">
                <i class="anticon anticon-building"></i> <%= current_organization.name %>
              </h6>
              <p class="text-muted mb-0">
                <% if current_org_setting %>
                  <%= current_org_setting.primary_address || 'No address set' %> Â· 
                  <%= current_organization.users.count %> users Â· 
                  Member since <%= current_organization.created_at.strftime('%B %Y') %>
                <% end %>
              </p>
            </div>
            <div class="col-md-4 text-md-end">
              <% if can?(:manage_settings) %>
                <%= link_to settings_organization_path, class: "btn btn-sm btn-outline-primary" do %>
                  <i class="bi bi-gear"></i> Organization Settings
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    
</div>

<!-- Chart.js -->
<script src="{% static 'assets/vendors/chartjs/Chart.min.js' %}"></script>


<script>
document.addEventListener('DOMContentLoaded', function () {

  // ----- Line Chart -----
  const ctxLine = document.getElementById("line-chart").getContext('2d');
  new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
      datasets: [{
        label: "Production Output",
        borderColor: "#3b82f6",
        backgroundColor: "rgba(59,130,246,0.1)",
        data: [4000, 8000, 9000, 12000, 12000, 13000, 16000],
        tension: 0.4,
        fill: true,
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: "#3b82f6"
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: "#6b7280" }, grid: { display: false } },
        y: {
          ticks: {
            color: "#6b7280",
            stepSize: 4000,
            callback: value => value >= 1000 ? (value / 1000) + 'k' : value
          },
          grid: { color: "#e5e7eb", borderDash: [3, 3] },
          beginAtZero: true,
          suggestedMax: 16000
        }
      }
    }
  });

  // ----- Bar Chart -----
  const ctxBar = document.getElementById("bar-chart").getContext('2d');
  new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: ["Dept A", "Dept B", "Dept C", "Dept D"],
      datasets: [{
        label: "Contribution",
        backgroundColor: "#3b82f6",
        data: [18, 30, 34, 40]
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: "#6b7280" }, grid: { display: false } },
        y: {
          ticks: { color: "#6b7280", callback: value => value + "%" },
          beginAtZero: true,
          max: 40,
          grid: { color: "#e5e7eb", borderDash: [3, 3] }
        }
      }
    }
  });

});
</script>
