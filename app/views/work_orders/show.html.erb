<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">View Work Order</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
        <a class="breadcrumb-item" href="#">Core Manufacturing</a>
        <a class="breadcrumb-item" href="/work_orders">Work Orders</a>
        <span class="breadcrumb-item active">View Work Order</span>
      </nav>
    </div>
  </div>
  <!-- app/views/work_orders/show.html.erb -->

  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          
          <h2 class="mb-1">
            <i class="bi bi-gear-wide-connected"></i> <%= @work_order.wo_number %>
          </h2>
          <p class="text-muted mb-0">
            <%= @work_order.product.sku %> - <%= @work_order.product.name %>
          </p>
        </div>
        
        <div class="text-end">
          <span class="text-white badge bg-<%= @work_order.status_badge_class %> fs-6 mb-2">
            <%= @work_order.status.titleize %>
          </span>
          <br>
          <span class="text-white badge bg-<%= @work_order.priority_badge_class %>">
            <%= @work_order.priority.titleize %> Priority
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons Row -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="btn-group" role="group">
        <%= link_to work_orders_path, class: "btn btn-outline-secondary" do %>
          <i class="bi bi-arrow-left"></i> Back to List
        <% end %>

        <% if @work_order.status == 'NOT_STARTED' %>
          <%= link_to edit_work_order_path(@work_order), class: "btn btn-outline-warning" do %>
            <i class="bi bi-pencil"></i> Edit
          <% end %>
        <% end %>

        <% if @work_order.can_be_released? %>
          <%= link_to release_work_order_path(@work_order), 
              class: "btn btn-success",
              data: { confirm: "Are you sure you want to release this Work Order to production? Operations and Materials will be created." } do %>
            <i class="bi bi-send"></i> Release to Production
          <% end %>
        <% end %>

        <% if @work_order.status.in?(['RELEASED', 'IN_PROGRESS']) %>
          <%= link_to assign_operators_work_order_path(@work_order), 
              class: "btn btn-info" do %>
            <i class="bi bi-people"></i> Assign Operators
          <% end %>
        <% end %>

        <% if @work_order.can_start_production? %>
          <%= link_to start_production_work_order_path(@work_order), 
              class: "btn btn-primary",
              data: { confirm: "Start production for this Work Order?" } do %>
            <i class="bi bi-play-circle"></i> Start Production
          <% end %>
        <% end %>

        <% if @work_order.can_be_completed? %>
          <%= link_to complete_work_order_path(@work_order), 
              class: "btn btn-success",
              data: { confirm: "Mark this Work Order as completed? Finished goods will be received to inventory." } do %>
            <i class="bi bi-check-circle"></i> Complete Work Order
          <% end %>
        <% end %>

        <% if @work_order.can_be_cancelled? %>
          <%= link_to cancel_work_order_path(@work_order), 
              class: "btn btn-danger",
              data: { confirm: "Are you sure you want to cancel this Work Order?" } do %>
            <i class="bi bi-x-circle"></i> Cancel
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
  <% if @work_order.status.in?(['NOT_STARTED', 'RELEASED']) %>
    <% shortage_details = @work_order.check_material_shortages %>
    <% if shortage_details.any? %>
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="alert alert-warning ">
            <h5 class="alert-heading">
              <i class="bi bi-exclamation-triangle"></i> Material Shortage Detected!
            </h5>
            <p class="mb-2">
              <strong><%= shortage_details.count %> material(s)</strong> are short for this work order. 
              Production may be delayed if materials are not procured.
            </p>
            
            <!-- Show shortage details in collapsible section -->
            <button class="btn btn-sm btn-warning mt-2" type="button" 
                    data-toggle="collapse" data-target="#shortageDetails">
              <i class="bi bi-list"></i> View Shortage Details
            </button>
            
            <div class="collapse mt-3" id="shortageDetails">
              <table class="table table-sm table-bordered bg-white mb-0">
                <thead>
                  <tr>
                    <th>Material</th>
                    <th>Required</th>
                    <th>Available</th>
                    <th>Shortage</th>
                  </tr>
                </thead>
                <tbody>
                  <% shortage_details.each do |shortage| %>
                    <tr>
                      <td>
                        <strong><%= shortage[:material_code] %></strong>
                        <br>
                        <small><%= shortage[:material_name] %></small>
                      </td>
                      <td><%= shortage[:required_qty] %> <%= shortage[:uom] %></td>
                      <td><%= shortage[:available_qty] %> <%= shortage[:uom] %></td>
                      <td class="text-danger">
                        <strong><%= shortage[:shortage_qty] %> <%= shortage[:uom] %></strong>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <div class="mt-3">
              <%= button_to "Send Shortage Alert Email", 
                  send_shortage_alert_work_order_path(@work_order), 
                  method: :post,
                  class: "btn btn-sm btn-outline-warning",
                  data: { confirm: "Send material shortage alert to inventory team?" } %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- Summary Cards Row -->
  <div class="row g-3 mb-4">
    <!-- Quantity Card -->
    <div class="col-md-3">
      <div class="card border-0  h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3">
            <i class="bi bi-box-seam"></i> Quantity
          </h6>
          <div class="row g-2">
            <div class="col-6">
              <small class="text-muted d-block">To Produce</small>
              <h5 class="mb-0">
                <%= number_with_precision(@work_order.quantity_to_produce, precision: 2) %>
              </h5>
              <small class="text-muted"><%= @work_order.uom.symbol %></small>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Completed</small>
              <h5 class="mb-0 text-success">
                <%= number_with_precision(@work_order.quantity_completed, precision: 2) %>
              </h5>
              <small class="text-muted"><%= @work_order.uom.symbol %></small>
            </div>
          </div>
          <div class="progress mt-3" style="height: 8px;">
            <div class="progress-bar bg-success" 
                 role="progressbar" 
                 style="width: <%= @quantity_progress %>%">
            </div>
          </div>
          <small class="text-muted"><%= number_with_precision(@quantity_progress, precision: 1) %>% Complete</small>
        </div>
      </div>
    </div>

    <!-- Schedule Card -->
    <div class="col-md-3">
      <div class="card border-0  h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3">
            <i class="bi bi-calendar-event"></i> Schedule
          </h6>
          <div class="mb-2">
            <small class="text-muted d-block">Start Date</small>
            <strong><%= @work_order.scheduled_start_date.strftime("%b %d, %Y") %></strong>
          </div>
          <div class="mb-2">
            <small class="text-muted d-block">End Date</small>
            <strong><%= @work_order.scheduled_end_date.strftime("%b %d, %Y") %></strong>
          </div>
          <% if @work_order.actual_start_date.present? %>
            <div class="mt-3 pt-2 border-top">
              <small class="text-muted d-block">Actually Started</small>
              <strong class="text-primary">
                <%= @work_order.actual_start_date.strftime("%b %d, %Y %I:%M %p") %>
              </strong>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Operations Progress Card -->
    <div class="col-md-3">
      <div class="card border-0  h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3">
            <i class="bi bi-list-check"></i> Operations
          </h6>
          <div class="text-center">
            <h2 class="mb-0">
              <%= @work_order.operations_completed_count %> / <%= @work_order.operations_total_count %>
            </h2>
            <small class="text-muted">Completed</small>
          </div>
          <div class="progress mt-3" style="height: 8px;">
            <div class="progress-bar bg-warning" 
                 role="progressbar" 
                 style="width: <%= @operations_progress %>%">
            </div>
          </div>
          <small class="text-muted"><%= number_with_precision(@operations_progress, precision: 1) %>% Complete</small>
        </div>
      </div>
    </div>

    <!-- Cost Card -->
    <div class="col-md-3">
      <div class="card border-0  h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3">
            <i class="bi bi-currency-dollar"></i> Cost Summary
          </h6>
          <div class="mb-2">
            <small class="text-muted d-block">Planned Cost</small>
            <h5 class="mb-0">
              $<%= number_with_precision(@work_order.total_planned_cost, precision: 2) %>
            </h5>
          </div>
          <div class="mb-2">
            <small class="text-muted d-block">Actual Cost</small>
            <h5 class="mb-0 text-primary">
              $<%= number_with_precision(@work_order.total_actual_cost, precision: 2) %>
            </h5>
          </div>
          <% if @work_order.status == 'COMPLETED' %>
            <div class="mt-2 pt-2 border-top">
              <small class="text-muted d-block">Variance</small>
              <strong class="<%= @cost_variance >= 0 ? 'text-success' : 'text-danger' %>">
                $<%= number_with_precision(@cost_variance.abs, precision: 2) %>
                (<%= @cost_variance >= 0 ? 'Under' : 'Over' %> Budget)
              </strong>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Details Card -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card ">
        <div class="card-header d-flex justify-content-start align-items-center bg-primary">
          <h6 class="mb-0"><i class="bi bi-info-circle"></i> Work Order Details</h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <small class="text-muted d-block">Product</small>
              <strong><%= @work_order.product.sku %></strong>
              <br>
              <small><%= @work_order.product.name %></small>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">BOM Used</small>
              <strong><%= @work_order.bom&.code || 'N/A' %></strong>
              <% if @work_order.bom.present? %>
                <br>
                <small><%= @work_order.bom.name %> (Rev: <%= @work_order.bom.revision %>)</small>
              <% end %>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Routing Used</small>
              <strong><%= @work_order.routing&.code || 'N/A' %></strong>
              <% if @work_order.routing.present? %>
                <br>
                <small><%= @work_order.routing.name %></small>
              <% end %>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Warehouse</small>
              <strong><%= @work_order.warehouse.name %></strong>
              <br>
              <small><%= @work_order.warehouse.code %></small>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Customer</small>
              <strong><%= @work_order.customer&.full_name || 'Stock Production' %></strong>
            </div>
            <div class="col-md-3">
              <small class="text-muted d-block">Created By</small>
              <strong><%= @work_order.created_by&.full_name || 'System' %></strong>
              <br>
              <small class="text-muted"><%= @work_order.created_at.strftime("%b %d, %Y") %></small>
            </div>
            <% if @work_order.released_by.present? %>
              <div class="col-md-3">
                <small class="text-muted d-block">Released By</small>
                <strong><%= @work_order.released_by.full_name || 'N/A' %></strong>
                <br>
                <small class="text-muted"><%= @work_order.released_at&.strftime("%b %d, %Y") %></small>
              </div>
            <% end %>
            <% if @work_order.completed_by.present? %>
              <div class="col-md-3">
                <small class="text-muted d-block">Completed By</small>
                <strong><%= @work_order.completed_by.full_name || 'N/A' %></strong>
                <br>
                <small class="text-muted"><%= @work_order.completed_at&.strftime("%b %d, %Y") %></small>
              </div>
            <% end %>
            <% if @work_order.notes.present? %>
              <div class="col-md-12">
                <small class="text-muted d-block">Notes</small>
                <p class="mb-0"><%= @work_order.notes %></p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="row">
    <div class="col-md-12">
      <ul class="nav nav-tabs" id="woTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" 
                  id="operations-tab" 
                  data-toggle="tab" 
                  data-target="#operations" 
                  type="button" 
                  role="tab">
            <i class="bi bi-list-task"></i> Operations 
            <span class="text-white badge bg-primary ms-1"><%= @operations.count %></span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" 
                  id="materials-tab" 
                  data-toggle="tab" 
                  data-target="#materials" 
                  type="button" 
                  role="tab">
            <i class="bi bi-box-seam"></i> Materials 
            <span class="text-white badge bg-primary ms-1"><%= @materials.count %></span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" 
                  id="costs-tab" 
                  data-toggle="tab" 
                  data-target="#costs" 
                  type="button" 
                  role="tab">
            <i class="bi bi-currency-dollar"></i> Cost Analysis
          </button>
        </li>
      </ul>

      <div class="tab-content border border-top-0 bg-white" id="woTabsContent">
        
        <!-- OPERATIONS TAB -->
        <div class="tab-pane fade show active p-4" id="operations" role="tabpanel">
          <%= render 'operations_tab', operations: @operations, work_order: @work_order %>
        </div>

        <!-- MATERIALS TAB -->
        <div class="tab-pane fade p-4" id="materials" role="tabpanel">
          <%= render 'materials_tab', materials: @materials, work_order: @work_order %>
        </div>

        <!-- COSTS TAB -->
        <div class="tab-pane fade p-4" id="costs" role="tabpanel">
          <%= render 'costs_tab', work_order: @work_order %>
        </div>

      </div>
    </div>
  </div>
</div>