<%# app/views/work_centers/index.html.erb %>

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Work Centers</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
        <a class="breadcrumb-item" href="#">Masters</a>
        <span class="breadcrumb-item active">Work Centers</span>
      </nav>
    </div>
  </div>
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-md-6">
      <h2 class="mb-0">
        <i class="fas fa-industry me-2"></i>
        Work Centers
      </h2>
      <p class="text-muted">Manage manufacturing work centers and stations</p>
    </div>
    <div class="col-md-6 d-flex justify-content-end align-items-center">
      <%= link_to new_work_center_path, class: "btn btn-primary" do %>
        <i class="fas fa-plus me-2"></i> New Work Center
      <% end %>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <%= form_with url: work_centers_path, method: :get, class: "row g-3" do |f| %>
        <!-- Search -->
        <div class="col-md-3">
          <label class="form-label">Search</label>
          <%= f.text_field :search, 
                          value: params[:search],
                          class: "form-control", 
                          placeholder: "Code, Name, Description..." %>
        </div>

        <!-- Warehouse Filter -->
        <div class="col-md-3">
          <label class="form-label">Warehouse</label>
          <%= f.select :warehouse_id, 
                      options_from_collection_for_select(
                        Warehouse.where(deleted: false).order(:name), 
                        :id, :name, params[:warehouse_id]
                      ),
                      { include_blank: "All Warehouses" },
                      { class: "form-control" } %>
        </div>

        <!-- Type Filter -->
        <div class="col-md-3">
          <label class="form-label">Type</label>
          <%= f.select :work_center_type,
                      options_for_select(
                        WorkCenter::WORK_CENTER_TYPES.map { |k, v| [v, k] },
                        params[:work_center_type]
                      ),
                      { include_blank: "All Types" },
                      { class: "form-control" } %>
        </div>

        <!-- Status Filter -->
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <%= f.select :status,
                      options_for_select(
                        [["Active", "active"], ["Inactive", "inactive"]],
                        params[:status]
                      ),
                      { include_blank: "All" },
                      { class: "form-control" } %>
        </div>

        <!-- Filter Buttons -->
        <div class="col-md-1 d-flex align-items-end">
          <%= f.submit "Filter", class: "btn btn-primary w-100 mb-2" %>
          <%= link_to "Reset", work_centers_path, class: "btn btn-outline-secondary w-100" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-primary">
        <div class="card-body text-center">
          <h3 class="text-primary mb-0">
            <%= WorkCenter.where(deleted: false).count %>
          </h3>
          <small class="text-muted">Total Work Centers</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <h3 class="text-success mb-0">
            <%= WorkCenter.where(deleted: false, is_active: true).count %>
          </h3>
          <small class="text-muted">Active</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <h3 class="text-warning mb-0">
            <%= WorkCenter.where(deleted: false, is_active: false).count %>
          </h3>
          <small class="text-muted">Inactive</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <h3 class="text-info mb-0">
            <%= WorkCenter::WORK_CENTER_TYPES.count %>
          </h3>
          <small class="text-muted">Work Center Types</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Work Centers Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <% if @work_centers.any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Type</th>
                <th>Warehouse</th>
                <th>Capacity/Hr</th>
                <th>Efficiency</th>
                <th>Cost/Hr</th>
                <th>Status</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @work_centers.each do |wc| %>
                <tr>
                  <td>
                    <strong><%= link_to wc.code, work_center_path(wc) %></strong>
                  </td>
                  <td><%= wc.name %></td>
                  <td>
                    <span class="badge bg-secondary">
                      <%= wc.type_label %>
                    </span>
                  </td>
                  <td>
                    <%= wc.warehouse&.name || "-" %>
                  </td>
                  <td>
                    <%= number_with_precision(wc.capacity_per_hour, precision: 2) %>
                    <small class="text-muted">units</small>
                  </td>
                  <td>
                    <div class="progress" style="height: 20px; margin-bottom: 0px;">
                      <div class="progress-bar <%= wc.efficiency_percent >= 90 ? 'bg-success' : wc.efficiency_percent >= 75 ? 'bg-warning' : 'bg-danger' %>" 
                           style="width: <%= wc.efficiency_percent %>%">
                        <%= wc.efficiency_percent %>%
                      </div>
                    </div>
                  </td>
                  <td>
                    <strong>$<%= number_with_precision(wc.total_cost_per_hour, precision: 2) %></strong>
                  </td>
                  <td>
                    <% if wc.is_active? %>
                      <span class="badge bg-success">Active</span>
                    <% else %>
                      <span class="badge bg-secondary">Inactive</span>
                    <% end %>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <%= link_to work_center_path(wc), class: "btn btn-sm btn-outline-primary", title: "View" do %>
                        View
                      <% end %>
                      <%= link_to edit_work_center_path(wc), class: "btn btn-sm btn-outline-warning", title: "Edit" do %>
                        Edit
                      <% end %>
                      <%= button_to toggle_status_work_center_path(wc), 
                                    method: :patch,
                                    class: "btn btn-sm btn-outline-#{wc.is_active? ? 'secondary' : 'success'}",
                                    title: wc.is_active? ? "Deactivate" : "Activate",
                                    data: { confirm: "Are you sure?" } do %>
                        <%= wc.is_active? ? "Deactivate" : "Activate" %>
                      <% end %>
                      <%= button_to work_center_path(wc), 
                                    method: :delete,
                                    class: "btn btn-sm btn-outline-danger",
                                    title: "Delete",
                                    data: { confirm: "Are you sure you want to delete this work center?" } do %>
                        Delete
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="mt-3">
          <%= paginate @work_centers %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="fas fa-industry fa-3x text-muted mb-3"></i>
          <p class="text-muted">No work centers found.</p>
          <%= link_to "Create First Work Center", new_work_center_path, class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
