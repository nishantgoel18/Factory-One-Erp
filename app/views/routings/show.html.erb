<%# app/views/work_centers/show.html.erb %>

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">View Routing</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
        <a class="breadcrumb-item" href="#">Masters</a>
        <a class="breadcrumb-item" href="/routings">Routings</a>
        <span class="breadcrumb-item active">View Routing</span>
      </nav>
    </div>
  </div>
  <!-- Breadcrumb & Header -->
  <!-- Breadcrumb & Header -->
  <div class="row mb-4">
    <div class="col-md-6">
      <h2 class="mb-0">
        <i class="fas fa-route me-2"></i>
        <%= @routing.code %>
      </h2>
      <p class="text-muted mb-0"><%= @routing.name %></p>
    </div>
    <div class="col-md-6 d-flex justify-content-end align-items-center">
      <!-- Status Badge -->
      <% case @routing.status %>
      <% when "ACTIVE" %>
        <span class="text-white badge bg-success fs-5 me-2 m-r-5">
          <i class="fas fa-check-circle me-1"></i> Active
        </span>
      <% when "DRAFT" %>
        <span class="text-white badge bg-warning fs-5 me-2 m-r-5">
          <i class="fas fa-pencil-alt me-1"></i> Draft
        </span>
      <% when "INACTIVE" %>
        <span class="text-white badge bg-secondary fs-5 me-2 m-r-5">
          <i class="fas fa-pause-circle me-1"></i> Inactive
        </span>
      <% when "ARCHIVED" %>
        <span class="text-white badge bg-dark fs-5 me-2 m-r-5">
          <i class="fas fa-archive me-1"></i> Archived
        </span>
      <% end %>
      
      <% if @routing.is_default? %>
        <span class="text-white badge bg-warning fs-5 me-2 m-r-5">
          <i class="fas fa-star me-1"></i> Default
        </span>
      <% end %>

      <!-- Action Buttons -->
      <div class="btn-group">
        <%= link_to edit_routing_path(@routing), class: "btn btn-warning" do %>
          <i class="fas fa-edit me-2"></i> Edit
        <% end %>
        
        <%= button_to duplicate_routing_path(@routing), 
                      method: :post,
                      class: "btn btn-info" do %>
          <i class="fas fa-copy me-2"></i> Duplicate
        <% end %>
        
        <%= button_to toggle_status_routing_path(@routing), 
                      method: :patch,
                      class: "btn btn-secondary",
                      data: { confirm: "Are you sure?" } do %>
          <i class="fas fa-exchange-alt me-2"></i> Change Status
        <% end %>
        
        <%= button_to routing_path(@routing), 
                      method: :delete,
                      class: "btn btn-danger",
                      data: { confirm: "Are you sure you want to delete this routing?" } do %>
          <i class="fas fa-trash me-2"></i> Delete
        <% end %>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column - Main Information -->
    <div class="col-lg-8">
      <!-- Basic Information Card -->
      <div class="card  mb-4">
        <div class="card-header d-flex align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Routing Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Routing Code</label>
              <div class="fs-5 fw-bold"><%= @routing.code %></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Routing Name</label>
              <div class="fs-5"><%= @routing.name %></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Product</label>
              <div>
                <%= link_to @routing.product.name, product_path(@routing.product), class: "text-decoration-none" %>
                <br>
                <small class="text-muted"><%= @routing.product.sku %></small>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <label class="text-muted small">Revision</label>
              <div>
                <span class="text-white badge bg-secondary fs-6"><%= @routing.revision %></span>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <label class="text-muted small">Status</label>
              <div>
                <% case @routing.status %>
                <% when "ACTIVE" %>
                  <span class="text-white badge bg-success fs-6">Active</span>
                <% when "DRAFT" %>
                  <span class="text-white badge bg-warning fs-6">Draft</span>
                <% when "INACTIVE" %>
                  <span class="text-white badge bg-secondary fs-6">Inactive</span>
                <% when "ARCHIVED" %>
                  <span class="text-white badge bg-dark fs-6">Archived</span>
                <% end %>
              </div>
            </div>
            <% if @routing.description.present? %>
              <div class="col-12 mb-3">
                <label class="text-muted small">Description</label>
                <div class="border rounded p-3 bg-primary">
                  <%= simple_format(@routing.description) %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Effective Dates Card -->
      <div class="card  mb-4">
        <div class="card-header d-flex align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i> Effective Dates
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="text-muted small">Effective From</label>
              <div class="fs-5">
                <%= @routing.effective_from.strftime("%B %d, %Y") %>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <label class="text-muted small">Effective To</label>
              <div class="fs-5">
                <%= @routing.effective_to&.strftime("%B %d, %Y") || "Indefinite" %>
              </div>
            </div>
          </div>
          
          <% if @routing.is_default? %>
            <div class="alert alert-warning mt-3 mb-0">
              <i class="fas fa-star me-2"></i>
              <strong>Default Routing:</strong> This is the default routing for <%= @routing.product.name %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Operations Sequence Card -->
      <div class="card  mb-4">
        <div class="card-header d-flex align-items-center bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-cogs me-2"></i>
            Operations Sequence
            <span class="text-white badge bg-primary text-dark ms-2" style="color: black !important;">
              <%= @operations.count %> Operations
            </span>
          </h5>
        </div>
        <div class="card-body p-0">
          <% if @operations.any? %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 10%;">Seq</th>
                    <th style="width: 25%;">Operation</th>
                    <th style="width: 25%;">Work Center</th>
                    <th style="width: 15%;" class="text-center">Setup Time</th>
                    <th style="width: 15%;" class="text-center">Run/Unit</th>
                    <th style="width: 10%;" class="text-center">QC</th>
                  </tr>
                </thead>
                <tbody>
                  <% @operations.each_with_index do |op, index| %>
                    <tr>
                      <td>
                        <span class="text-white badge bg-primary fs-6">
                          <%= op.operation_sequence %>
                        </span>
                      </td>
                      <td>
                        <strong><%= op.operation_name %></strong>
                        <% if op.description.present? %>
                          <br>
                          <small class="text-muted"><%= truncate(op.description, length: 60) %></small>
                        <% end %>
                      </td>
                      <td>
                        <%= op.work_center.display_name %>
                        <br>
                        <small class="text-muted"><%= op.work_center.type_label %></small>
                      </td>
                      <td class="text-center">
                        <strong><%= number_with_precision(op.setup_time_minutes, precision: 1) %></strong>
                        <small class="text-muted">min</small>
                      </td>
                      <td class="text-center">
                        <strong><%= number_with_precision(op.run_time_per_unit_minutes, precision: 1) %></strong>
                        <small class="text-muted">min</small>
                      </td>
                      <td class="text-center">
                        <% if op.is_quality_check_required? %>
                          <i class="fas fa-check-circle text-success fs-5" title="Quality Check Required"></i>
                        <% else %>
                          <i class="fas fa-minus-circle text-muted" title="No QC"></i>
                        <% end %>
                      </td>
                    </tr>
                    
                    <!-- Expandable Details Row -->
                    <tr class="collapse" id="operation-details-<%= op.id %>">
                      <td colspan="6" class="bg-primary">
                        <div class="p-3">
                          <div class="row">
                            <div class="col-md-3">
                              <label class="text-muted small">Wait Time</label>
                              <div><%= op.wait_time_minutes %> minutes</div>
                            </div>
                            <div class="col-md-3">
                              <label class="text-muted small">Move Time</label>
                              <div><%= op.move_time_minutes %> minutes</div>
                            </div>
                            <div class="col-md-3">
                              <label class="text-muted small">Labor Hours/Unit</label>
                              <div><%= number_with_precision(op.labor_hours_per_unit, precision: 2) %> hrs</div>
                            </div>
                            <div class="col-md-3">
                              <label class="text-muted small">Total Time/Unit</label>
                              <div><strong><%= number_with_precision(op.total_time_per_unit, precision: 1) %></strong> minutes</div>
                            </div>
                          </div>
                          
                          <hr>
                          
                          <div class="row">
                            <div class="col-md-4">
                              <label class="text-muted small">Labor Cost/Unit</label>
                              <div class="fs-5 text-primary">
                                $<%= number_with_precision(op.labor_cost_per_unit, precision: 2) %>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <label class="text-muted small">Overhead Cost/Unit</label>
                              <div class="fs-5 text-info">
                                $<%= number_with_precision(op.overhead_cost_per_unit, precision: 2) %>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <label class="text-muted small">Total Cost/Unit</label>
                              <div class="fs-5 fw-bold text-success">
                                $<%= number_with_precision(op.total_cost_per_unit, precision: 2) %>
                              </div>
                            </div>
                          </div>
                          
                          <% if op.quality_check_instructions.present? %>
                            <hr>
                            <label class="text-muted small">Quality Check Instructions</label>
                            <div class="border rounded p-2 bg-white">
                              <%= simple_format(op.quality_check_instructions) %>
                            </div>
                          <% end %>
                          
                          <% if op.notes.present? %>
                            <hr>
                            <label class="text-muted small">Notes</label>
                            <div class="border rounded p-2 bg-white">
                              <%= simple_format(op.notes) %>
                            </div>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                    
                    <!-- Toggle Details Button Row -->
                    <tr>
                      <td colspan="6" class="py-0">
                        <a class="btn btn-link btn-sm w-100 text-decoration-none" 
                           data-toggle="collapse" 
                           href="#operation-details-<%= op.id %>" 
                           role="button">
                          <i class="fas fa-chevron-down me-1"></i>
                          View Details
                        </a>
                      </td>
                    </tr>
                    
                    <% unless index == @operations.count - 1 %>
                      <tr class="table-light">
                        <td colspan="6" class="text-center py-2">
                          <i class="fas fa-arrow-down text-muted"></i>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
              <p class="text-muted">No operations defined yet.</p>
              <%= link_to "Add Operations", edit_routing_path(@routing), class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Visual Flow Chart -->
      <% if @operations.any? %>
        <div class="card  mb-4">
          <div class="card-header d-flex align-items-center bg-secondary text-white">
            <h5 class="mb-0">
              <i class="fas fa-project-diagram me-2"></i> Process Flow
            </h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-column align-items-center">
              <% @operations.each_with_index do |op, index| %>
                <!-- Operation Box -->
                <div class="border rounded p-3 mb-3 text-center" style="width: 80%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <div class="fw-bold fs-5"><%= op.operation_sequence %> - <%= op.operation_name %></div>
                  <div class="small mt-1">
                    <i class="fas fa-industry me-1"></i> <%= op.work_center.name %>
                  </div>
                  <div class="small mt-2">
                    <span class="text-white badge bg-primary text-dark" style="color: black !important;">
                      Setup: <%= op.setup_time_minutes %>m
                    </span>
                    <span class="text-white badge bg-primary text-dark ms-1" style="color: black !important;">
                      Run: <%= op.run_time_per_unit_minutes %>m/unit
                    </span>
                  </div>
                </div>
                
                <!-- Arrow -->
                <% unless index == @operations.count - 1 %>
                  <div class="mb-3">
                    <i class="fas fa-arrow-down fa-2x text-primary"></i>
                  </div>
                <% end %>
              <% end %>
              
              <!-- Final Output -->
              <div class="border rounded p-3 text-center" style="width: 80%; background: #28a745; color: white;">
                <div class="fw-bold fs-5">
                  <i class="fas fa-check-circle me-2"></i>
                  Finished Product
                </div>
                <div class="small mt-1"><%= @routing.product.name %></div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Notes Card -->
      <% if @routing.notes.present? %>
        <div class="card  mb-4">
          <div class="card-header d-flex align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-sticky-note me-2"></i> Additional Notes
            </h5>
          </div>
          <div class="card-body">
            <div class="border rounded p-3 bg-primary">
              <%= simple_format(@routing.notes) %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Right Column - Summary & Analytics -->
    <div class="col-lg-4">
      <!-- Time Summary Card -->
      <div class="card  mb-4 border-primary">
        <div class="card-header d-flex align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-clock me-2"></i> Time Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="text-muted small">Total Setup Time</label>
            <div class="fs-3 fw-bold text-primary">
              <%= number_with_precision(@routing.total_setup_time_minutes, precision: 1) %>
              <small class="text-muted">min</small>
            </div>
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>
              <%= distance_of_time_in_words(@routing.total_setup_time_minutes.minutes) %>
            </small>
          </div>
          
          <hr>
          
          <div class="mb-3">
            <label class="text-muted small">Run Time per Unit</label>
            <div class="fs-3 fw-bold text-info">
              <%= number_with_precision(@routing.total_run_time_per_unit_minutes, precision: 1) %>
              <small class="text-muted">min</small>
            </div>
          </div>
          
          <hr>
          
          <div class="mb-0">
            <label class="text-muted small">Total Operations</label>
            <div class="fs-3 fw-bold text-success">
              <%= @operations.count %>
              <small class="text-muted">ops</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Cost Summary Card -->
      <div class="card  mb-4 border-warning">
        <div class="card-header d-flex align-items-center bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fas fa-dollar-sign me-2"></i> Cost Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="text-muted small">Labor Cost per Unit</label>
            <div class="fs-3 fw-bold text-primary">
              $<%= number_with_precision(@routing.total_labor_cost_per_unit, precision: 2) %>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="text-muted small">Overhead Cost per Unit</label>
            <div class="fs-3 fw-bold text-info">
              $<%= number_with_precision(@routing.total_overhead_cost_per_unit, precision: 2) %>
            </div>
          </div>
          
          <hr>
          
          <div class="mb-0">
            <label class="text-muted small">Total Cost per Unit</label>
            <div class="fs-2 fw-bold text-success">
              $<%= number_with_precision(@routing.total_cost_per_unit, precision: 2) %>
            </div>
          </div>
        </div>
        <div class="card-footer bg-primary">
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Includes labor and overhead costs from all operations
          </small>
        </div>
      </div>

      <!-- Batch Cost Calculator -->
      <div class="card  mb-4 border-success">
        <div class="card-header d-flex align-items-center bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-calculator me-2"></i> Batch Cost Calculator
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Batch Quantity</label>
            <input type="number" id="batch-quantity" class="form-control" value="100" min="1">
          </div>
          
          <hr>
          
          <div class="mb-2">
            <label class="text-muted small">Total Setup Cost</label>
            <div class="fs-5 fw-bold">
              $<span id="batch-setup-cost">0.00</span>
            </div>
          </div>
          
          <div class="mb-2">
            <label class="text-muted small">Total Run Cost</label>
            <div class="fs-5 fw-bold">
              $<span id="batch-run-cost">0.00</span>
            </div>
          </div>
          
          <hr>
          
          <div class="mb-2">
            <label class="text-muted small">Total Batch Cost</label>
            <div class="fs-3 fw-bold text-success">
              $<span id="batch-total-cost">0.00</span>
            </div>
          </div>
          
          <div class="mb-0">
            <label class="text-muted small">Cost per Unit</label>
            <div class="fs-5 fw-bold text-primary">
              $<span id="batch-unit-cost">0.00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Critical Path Card -->
      <% if @routing.critical_operation.present? %>
        <div class="card  mb-4 border-danger">
          <div class="card-header d-flex align-items-center bg-danger text-white">
            <h5 class="mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i> Critical Operation
            </h5>
          </div>
          <div class="card-body">
            <% critical = @routing.critical_operation %>
            <div class="mb-2">
              <label class="text-muted small">Operation</label>
              <div class="fs-5 fw-bold">
                <%= critical.operation_sequence %> - <%= critical.operation_name %>
              </div>
            </div>
            <div class="mb-2">
              <label class="text-muted small">Work Center</label>
              <div><%= critical.work_center.display_name %></div>
            </div>
            <div class="mb-0">
              <label class="text-muted small">Time per Unit</label>
              <div class="fs-4 fw-bold text-danger">
                <%= number_with_precision(critical.total_time_per_unit, precision: 1) %> minutes
              </div>
            </div>
          </div>
          <div class="card-footer bg-primary">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Longest operation - potential bottleneck
            </small>
          </div>
        </div>
      <% end %>

      <!-- Audit Information Card -->
      <div class="card  mb-4">
        <div class="card-header d-flex align-items-center bg-primary">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i> Audit Information
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-2">
            <label class="text-muted small">Created At</label>
            <div>
              <%= @routing.created_at.strftime("%B %d, %Y at %I:%M %p") %>
            </div>
          </div>
          
          <div class="mb-2">
            <label class="text-muted small">Last Updated</label>
            <div>
              <%= @routing.updated_at.strftime("%B %d, %Y at %I:%M %p") %>
            </div>
          </div>
          
          <% if @routing.created_by.present? %>
            <div class="mb-0">
              <label class="text-muted small">Created By</label>
              <div>
                <i class="fas fa-user me-1"></i>
                <%= @routing.created_by.full_name || @routing.created_by.email %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Cost Calculator -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const quantityInput = document.getElementById('batch-quantity');
  const setupCostSpan = document.getElementById('batch-setup-cost');
  const runCostSpan = document.getElementById('batch-run-cost');
  const totalCostSpan = document.getElementById('batch-total-cost');
  const unitCostSpan = document.getElementById('batch-unit-cost');
  
  const costPerUnit = <%= @routing.total_cost_per_unit %>;
  const setupTime = <%= @routing.total_setup_time_minutes %>;
  
  // Calculate setup cost from all operations
  const setupCost = <%= @operations.sum { |op| op.calculate_setup_cost } %>;
  
  function calculateBatchCost() {
    const quantity = parseInt(quantityInput.value) || 1;
    
    const runCost = costPerUnit * quantity;
    const totalCost = setupCost + runCost;
    const unitCost = totalCost / quantity;
    
    setupCostSpan.textContent = setupCost.toFixed(2);
    runCostSpan.textContent = runCost.toFixed(2);
    totalCostSpan.textContent = totalCost.toFixed(2);
    unitCostSpan.textContent = unitCost.toFixed(2);
  }
  
  quantityInput.addEventListener('input', calculateBatchCost);
  
  // Initial calculation
  calculateBatchCost();
});
</script>