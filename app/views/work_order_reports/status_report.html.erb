<!-- app/views/reports/work_order_reports/status_report.html.erb -->

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Status Report</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>  Home</a>
        <a class="breadcrumb-item" href="#">Reports</a>
        <a class="breadcrumb-item" href="/reports/work_order">Work Orders</a>

        <span class="breadcrumb-item active">Status Report</span>
      </nav>
    </div>
  </div>
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-file-text"></i> Work Order Status Report
      </h2>
      <p class="text-muted mb-0">
        Period: <%= @start_date.strftime("%B %d, %Y") %> to <%= @end_date.strftime("%B %d, %Y") %>
      </p>
    </div>
    <div>
      <%= link_to "Export PDF", status_report_work_order_path(format: :pdf, 
          start_date: @start_date, end_date: @end_date, status: params[:status]), 
          class: "btn btn-danger me-2", target: "_blank" %>
      <%= link_to "Export CSV", status_report_work_order_path(format: :csv, 
          start_date: @start_date, end_date: @end_date, status: params[:status]), 
          class: "btn btn-success" %>
    </div>
  </div>

  <!-- Filters -->
  <div class="card  mb-4">
    <div class="card-body">
      <%= form_with url: status_report_work_order_path, method: :get, class: "row g-3" do |f| %>
        <div class="col-md-3">
          <%= f.label :start_date, "Start Date", class: "form-label" %>
          <%= f.date_field :start_date, value: @start_date, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :end_date, "End Date", class: "form-label" %>
          <%= f.date_field :end_date, value: @end_date, class: "form-control" %>
        </div>
        <div class="col-md-2">
          <%= f.label :status, "Status", class: "form-label" %>
          <%= f.select :status, 
              options_for_select(WorkOrder::STATUSES.map { |s| [s.titleize, s] }, params[:status]),
              { include_blank: "All" },
              { class: "form-control" } %>
        </div>
        <div class="col-md-2">
          <%= f.label :warehouse_id, "Warehouse", class: "form-label" %>
          <%= f.select :warehouse_id,
              options_from_collection_for_select(@warehouses, :id, :name, params[:warehouse_id]),
              { include_blank: "All" },
              { class: "form-control" } %>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <%= f.submit "Generate Report", class: "btn btn-primary w-100" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-2">
      <div class="card ">
        <div class="card-body">
          <h6 class="text-muted mb-2 small">Total Work Orders</h6>
          <h3 class="mb-0"><%= @stats[:total_wos] %></h3>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card ">
        <div class="card-body">
          <h6 class="text-muted mb-2 small">Completed</h6>
          <h3 class="mb-0 text-success"><%= @stats[:by_status][:completed] %></h3>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card ">
        <div class="card-body">
          <h6 class="text-muted mb-2 small">In Progress</h6>
          <h3 class="mb-0 text-warning"><%= @stats[:by_status][:in_progress] %></h3>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card ">
        <div class="card-body">
          <h6 class="text-muted mb-2 small">On-Time Rate</h6>
          <h3 class="mb-0 text-info"><%= @stats[:on_time_completion] %>%</h3>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card ">
        <div class="card-body">
          <h6 class="text-muted mb-2 small">Avg Completion</h6>
          <h3 class="mb-0"><%= @stats[:avg_completion_days] %> days</h3>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card ">
        <div class="card-body">
          <h6 class="text-muted mb-2 small">Total Quantity</h6>
          <h3 class="mb-0"><%= number_with_precision(@stats[:total_quantity], precision: 0) %></h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Breakdown Chart -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card ">
        <div class="card-header">
          <h6 class="mb-0">Work Orders by Status</h6>
        </div>
        <div class="card-body">
          <canvas id="statusChart" height="250"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card ">
        <div class="card-header">
          <h6 class="mb-0">Work Orders by Priority</h6>
        </div>
        <div class="card-body">
          <canvas id="priorityChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Table -->
  <div class="card ">
    <div class="card-header">
      <h6 class="mb-0">Detailed Work Order List</h6>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>WO Number</th>
              <th>Product</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Quantity</th>
              <th>Progress</th>
              <th>Scheduled</th>
              <th>Actual</th>
              <th>Days Taken</th>
            </tr>
          </thead>
          <tbody>
            <% @work_orders.each do |wo| %>
              <tr>
                <td>
                  <%= link_to wo.wo_number, work_order_path(wo), class: "fw-semibold text-decoration-none" %>
                </td>
                <td>
                  <%= wo.product.sku %>
                  <br>
                  <small class="text-muted"><%= wo.product.name %></small>
                </td>
                <td>
                  <span class="badge bg-<%= wo.status_badge_class %>">
                    <%= wo.status.titleize %>
                  </span>
                </td>
                <td>
                  <span class="badge bg-<%= wo.priority_badge_class %>">
                    <%= wo.priority.titleize %>
                  </span>
                </td>
                <td>
                  <%= number_with_precision(wo.quantity_to_produce, precision: 2) %> <%= wo.uom.symbol %>
                  <% if wo.status == 'COMPLETED' %>
                    <br>
                    <small class="text-success">Completed: <%= number_with_precision(wo.quantity_completed, precision: 2) %></small>
                  <% end %>
                </td>
                <td>
                  <div class="progress" style="height: 20px; width: 100px; margin-bottom: 0px;">
                    <div class="progress-bar bg-success" 
                         style="width: <%= wo.progress_percentage %>%">
                      <%= number_with_precision(wo.progress_percentage, precision: 0) %>%
                    </div>
                  </div>
                </td>
                <td>
                  <small>
                    <%= wo.scheduled_start_date.strftime("%b %d") %> - 
                    <%= wo.scheduled_end_date.strftime("%b %d, %Y") %>
                  </small>
                </td>
                <td>
                  <% if wo.actual_start_date.present? %>
                    <small>
                      <%= wo.actual_start_date.strftime("%b %d") %>
                      <% if wo.actual_end_date.present? %>
                        - <%= wo.actual_end_date.strftime("%b %d, %Y") %>
                      <% end %>
                    </small>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if wo.status == 'COMPLETED' && wo.actual_start_date.present? %>
                    <% days = (wo.actual_end_date.to_date - wo.actual_start_date.to_date).to_i %>
                    <%= days %> days
                    <% if days <= (wo.scheduled_end_date - wo.scheduled_start_date).to_i %>
                      <i class="bi bi-check-circle text-success"></i>
                    <% else %>
                      <i class="bi bi-exclamation-circle text-danger"></i>
                    <% end %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Status Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Not Started', 'Released', 'In Progress', 'Completed', 'Cancelled'],
      datasets: [{
        data: [
          <%= @stats[:by_status][:not_started] %>,
          <%= @stats[:by_status][:released] %>,
          <%= @stats[:by_status][:in_progress] %>,
          <%= @stats[:by_status][:completed] %>,
          <%= @stats[:by_status][:cancelled] %>
        ],
        backgroundColor: [
          '#6c757d',
          '#0dcaf0',
          '#ffc107',
          '#198754',
          '#dc3545'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Priority Chart
  const priorityCtx = document.getElementById('priorityChart').getContext('2d');
  new Chart(priorityCtx, {
    type: 'bar',
    data: {
      labels: ['Urgent', 'High', 'Normal', 'Low'],
      datasets: [{
        label: 'Work Orders',
        data: [
          <%= @stats[:by_priority][:urgent] %>,
          <%= @stats[:by_priority][:high] %>,
          <%= @stats[:by_priority][:normal] %>,
          <%= @stats[:by_priority][:low] %>
        ],
        backgroundColor: [
          '#dc3545',
          '#ffc107',
          '#0dcaf0',
          '#6c757d'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
</script>