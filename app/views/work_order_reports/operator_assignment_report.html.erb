<!-- app/views/reports/work_order_reports/operator_assignment_report.html.erb -->

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Operation Assignment Report</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>  Home</a>
        <a class="breadcrumb-item" href="#">Reports</a>
        <a class="breadcrumb-item" href="/reports/work_order">Work Orders</a>

        <span class="breadcrumb-item active">Operation Assignment Report</span>
      </nav>
    </div>
  </div>
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-clipboard-check"></i> Operator Assignment Report
      </h2>
      <p class="text-muted mb-0">
        Period: <%= @start_date.strftime("%B %d, %Y") %> to <%= @end_date.strftime("%B %d, %Y") %>
      </p>
    </div>
    <div>
      <%= link_to "Export PDF", operator_assignment_report_reports_work_order_path(format: :pdf, 
          start_date: @start_date, end_date: @end_date), 
          class: "btn btn-danger me-2", target: "_blank" %>
      <%= link_to "Export CSV", operator_assignment_report_reports_work_order_path(format: :csv, 
          start_date: @start_date, end_date: @end_date), 
          class: "btn btn-success" %>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <%= form_with url: operator_assignment_report_reports_work_order_reports_path, method: :get, class: "row g-3" do |f| %>
        <div class="col-md-4">
          <%= f.label :start_date, "Start Date", class: "form-label" %>
          <%= f.date_field :start_date, value: @start_date, class: "form-control" %>
        </div>
        <div class="col-md-4">
          <%= f.label :end_date, "End Date", class: "form-label" %>
          <%= f.date_field :end_date, value: @end_date, class: "form-control" %>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <%= f.submit "Generate Report", class: "btn btn-primary w-100" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-primary">
        <div class="card-body text-center">
          <i class="bi bi-list-task text-primary fs-1 d-block mb-2"></i>
          <h6 class="text-muted mb-1 small">Total Operations</h6>
          <h3 class="mb-0 text-primary"><%= @total_operations %></h3>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-success">
        <div class="card-body text-center">
          <i class="bi bi-check-circle text-success fs-1 d-block mb-2"></i>
          <h6 class="text-muted mb-1 small">Assigned</h6>
          <h3 class="mb-0 text-success"><%= @assigned_operations %></h3>
          <small class="text-muted"><%= @assignment_rate %>%</small>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-warning">
        <div class="card-body text-center">
          <i class="bi bi-exclamation-circle text-warning fs-1 d-block mb-2"></i>
          <h6 class="text-muted mb-1 small">Unassigned</h6>
          <h3 class="mb-0 text-warning"><%= @unassigned_operations %></h3>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-info">
        <div class="card-body text-center">
          <i class="bi bi-arrow-repeat text-info fs-1 d-block mb-2"></i>
          <h6 class="text-muted mb-1 small">Compliance Rate</h6>
          <h3 class="mb-0 text-info"><%= @compliance_rate %>%</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Flow Chart -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">Assignment Distribution</h6>
        </div>
        <div class="card-body">
          <canvas id="assignmentChart" height="250"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">Completion Compliance</h6>
        </div>
        <div class="card-body">
          <canvas id="complianceChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Operator Assignment Details -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <h6 class="mb-0">
        <i class="bi bi-people"></i> Operator Assignment Details
      </h6>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Operator</th>
              <th>Total Assigned</th>
              <th>Pending</th>
              <th>Completed</th>
              <th>By Self</th>
              <th>By Others</th>
              <th>Compliance %</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% @operator_assignments.each do |data| %>
              <tr>
                <td>
                  <strong><%= data[:operator].full_name %></strong>
                  <br>
                  <small class="text-muted"><%= data[:operator].email %></small>
                </td>
                <td>
                  <span class="badge bg-primary">
                    <%= data[:total_assigned] %>
                  </span>
                </td>
                <td>
                  <span class="badge bg-warning">
                    <%= data[:pending] %>
                  </span>
                </td>
                <td>
                  <span class="badge bg-success">
                    <%= data[:completed] %>
                  </span>
                </td>
                <td>
                  <strong class="text-success">
                    <%= data[:completed_by_self] %>
                  </strong>
                </td>
                <td>
                  <% if data[:completed_by_others] > 0 %>
                    <strong class="text-warning">
                      <%= data[:completed_by_others] %>
                    </strong>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <div class="progress" style="height: 25px; width: 100px;">
                    <div class="progress-bar bg-<%= data[:compliance_rate] >= 80 ? 'success' : data[:compliance_rate] >= 60 ? 'warning' : 'danger' %>" 
                         style="width: <%= data[:compliance_rate] %>%">
                      <%= data[:compliance_rate] %>%
                    </div>
                  </div>
                </td>
                <td>
                  <% if data[:compliance_rate] >= 80 %>
                    <span class="badge bg-success">Excellent</span>
                  <% elsif data[:compliance_rate] >= 60 %>
                    <span class="badge bg-warning">Good</span>
                  <% else %>
                    <span class="badge bg-danger">Poor</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Assignment Chart
  const assignmentCtx = document.getElementById('assignmentChart').getContext('2d');
  new Chart(assignmentCtx, {
    type: 'doughnut',
    data: {
      labels: ['Assigned', 'Unassigned'],
      datasets: [{
        data: [<%= @assigned_operations %>, <%= @unassigned_operations %>],
        backgroundColor: ['#198754', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Compliance Chart
  const complianceCtx = document.getElementById('complianceChart').getContext('2d');
  new Chart(complianceCtx, {
    type: 'bar',
    data: {
      labels: ['Completed as Assigned', 'Reassigned'],
      datasets: [{
        label: 'Operations',
        data: [<%= @completed_as_assigned %>, <%= @reassigned %>],
        backgroundColor: ['#198754', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
</script>
