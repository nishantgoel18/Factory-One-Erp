<%# app/views/inventory/stock_adjustments/_form.html.erb %>

<%= simple_form_for [:inventory, @stock_adjustment] do |f| %>
<%= render 'layouts/error_messages', object: @stock_adjustment %>
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <h5 class="mb-0">Adjustment Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <%= f.association :warehouse,
              collection: Warehouse.where(deleted: false, is_active: true).order(:name),
              input_html: { class: 'form-control' } %>
        </div>
        
        <div class="col-md-4">
          <%= f.input :adjustment_date,
              as: :date,
              input_html: { class: 'form-control' } %>
        </div>
        
        <div class="col-md-12 mt-3">
          <%= f.input :reason,
              as: :text,
              input_html: { class: 'form-control', rows: 2 },
              hint: 'Provide detailed reason for adjustment (minimum 10 characters)',
              required: true %>
        </div>
        
        <div class="col-md-12">
          <%= f.input :notes,
              as: :text,
              input_html: { class: 'form-control', rows: 2 },
              label: 'Additional Notes (Optional)' %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Adjustment Lines</h5>
      <button type="button" class="btn btn-sm btn-light" id="add-adjustment-line">
        <i class="bi bi-plus-circle"></i> Add Line
      </button>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Note:</strong> Enter positive values to increase stock, negative values to decrease.
      </div>
      
      <div id="adjustment-lines-container">
        <%= f.simple_fields_for :lines do |line_form| %>
          <%= render 'line_fields', f: line_form %>
        <% end %>
      </div>

      <template id="adjustment-line-template">
        <%= f.simple_fields_for :lines, StockAdjustmentLine.new, child_index: 'NEW_RECORD' do |line_form| %>
          <%= render 'line_fields', f: line_form %>
        <% end %>
      </template>
    </div>
  </div>

  <div class="d-flex justify-content-between">
    <%= link_to 'Cancel', inventory_stock_adjustments_path, class: 'btn btn-secondary' %>
    <%= f.submit 'Save Adjustment', class: 'btn btn-primary' %>
  </div>
<% end %>


<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add new line item
  document.getElementById('add-adjustment-line').addEventListener('click', function() {
    const template = document.getElementById('adjustment-line-template');
    const content = template.content.cloneNode(true);
    const html = content.firstElementChild.outerHTML.replace(/NEW_RECORD/g, new Date().getTime());
    document.getElementById('adjustment-lines-container').insertAdjacentHTML('beforeend', html);
  });
  
  // Remove line item
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-adjustment-line')) {
      const lineItem = e.target.closest('.adjustment-line-row');
      const destroyInput = lineItem.querySelector('input[name*="_destroy"]');
      
      if (destroyInput) {
        destroyInput.value = '1';
        lineItem.style.display = 'none';
      } else {
        lineItem.remove();
      }
    }
  });
});
</script>
