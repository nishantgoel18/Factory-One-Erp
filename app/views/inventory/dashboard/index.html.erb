<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="container-fluid">
    <div class="page-header">
      <h2 class="header-title">Inventory Dashboard</h2>
      <p class="text-muted">Welcome back! Here's your inventory overview</p>
    </div>
  </div>

  <div class="row mb-4">
    <!-- Total Products -->
    <div class="col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <h3>Total Products</h3>
          <div class="media align-items-center">
            <div class="avatar avatar-icon avatar-lg avatar-green">
              <i class="fa fa-cog" aria-hidden="true"></i>
            </div>
            <div class="m-l-15">
              <h2 class="m-b-0"><%= @total_products %></h2>
              <p class="m-b-0 text-muted">Active stocked items</p>
            </div>
          </div>
        </div>
      </div>
      
    </div>

    <!-- Total Warehouses -->
    <div class="col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <h3>Warehouses</h3>
          <div class="media align-items-center">
            <div class="avatar avatar-icon avatar-lg avatar-blue">
              <i class="fa fa-building" aria-hidden="true"></i>
            </div>
            <div class="m-l-15">
              <h2 class="m-b-0"><%= @total_warehouses %></h2>
              <p class="m-b-0 text-muted">Active locations</p>
            </div>
          </div>
        </div>
      </div>
      
    </div>

    <!-- Low Stock Alerts -->
    <div class="col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <h3>Low Stock Items</h3>
          <div class="media align-items-center">
            <div class="avatar avatar-icon avatar-lg avatar-red">
              <i class="anticon anticon-calculator" aria-hidden="true"></i>
            </div>
            <div class="m-l-15">
              <h2 class="m-b-0"><%= @low_stock_count %></h2>
              <p class="m-b-0 text-muted"><%= link_to 'View Details', low_stock_path %></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Stock Value -->
    <div class="col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <h3>Stock Value</h3>
          <div class="media align-items-center">
            <div class="avatar avatar-icon avatar-lg avatar-green">
              <i class="anticon anticon-dollar" aria-hidden="true"></i>
            </div>
            <div class="m-l-15">
              <h2 class="m-b-0"><%= number_to_currency(@total_stock_value, precision: 0) %></h2>
              <p class="m-b-0 text-muted">Total inventory value</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <!-- Stock Movements Chart -->
    <div class="col-md-8 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-graph-up me-2"></i>
            Stock Movements (Last 30 Days)
          </h5>
        </div>
        <div class="card-body">
          <canvas id="stockMovementChart" height="80"></canvas>
        </div>
      </div>
    </div>

    <!-- Warehouse Distribution -->
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart me-2"></i>
            Stock by Warehouse
          </h5>
        </div>
        <div class="card-body">
          <canvas id="warehouseDistributionChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity & Alerts Row -->
  <div class="row">
    <!-- Recent Receipts -->
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="bi bi-box-arrow-in-down me-2 text-success"></i>
            Recent Receipts
          </h6>
          <%= link_to 'View All', inventory_goods_receipts_path, 
              class: 'btn btn-sm btn-outline-secondary' %>
        </div>
        <div class="card-body p-0">
          <% if @recent_grns.any? %>
            <div class="list-group list-group-flush">
              <% @recent_grns.each do |grn| %>
                <%= link_to inventory_goods_receipt_path(grn), 
                    class: 'list-group-item list-group-item-action' do %>
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong><%= grn.reference_no %></strong><br>
                      <small class="text-muted">
                        <%= grn.warehouse.name %>
                        <% if grn.supplier %>
                          â€¢ <%= grn.supplier.name %>
                        <% end %>
                      </small>
                    </div>
                    <small class="text-muted">
                      <%= time_ago_in_words(grn.posted_at) %> ago
                    </small>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-inbox display-6"></i>
              <p class="mb-0 mt-2">No recent receipts</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Recent Issues -->
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="bi bi-box-arrow-right me-2 text-danger"></i>
            Recent Issues
          </h6>
          <%= link_to 'View All', inventory_stock_issues_path, 
              class: 'btn btn-sm btn-outline-secondary' %>
        </div>
        <div class="card-body p-0">
          <% if @recent_issues.any? %>
            <div class="list-group list-group-flush">
              <% @recent_issues.each do |issue| %>
                <%= link_to inventory_stock_issue_path(issue), 
                    class: 'list-group-item list-group-item-action' do %>
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong><%= issue.reference_no %></strong><br>
                      <small class="text-muted">
                        <%= issue.warehouse.name %>
                      </small>
                    </div>
                    <small class="text-muted">
                      <%= time_ago_in_words(issue.created_at) %> ago
                    </small>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-inbox display-6"></i>
              <p class="mb-0 mt-2">No recent issues</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Pending POs & Alerts -->
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="bi bi-bell me-2 text-warning"></i>
            Alerts & Pending
          </h6>
        </div>
        <div class="card-body">
          <!-- Overdue POs Alert -->
          <% if @overdue_pos > 0 %>
            <div class="alert alert-danger mb-3">
              <i class="bi bi-exclamation-circle me-2"></i>
              <strong><%= @overdue_pos %></strong> overdue purchase orders
              <%= link_to 'View', overdue_inventory_purchase_orders_path, 
                  class: 'alert-link float-end' %>
            </div>
          <% end %>

          <!-- Low Stock Alert -->
          <% if @low_stock_count > 0 %>
            <div class="alert alert-warning mb-3">
              <i class="bi bi-box-seam me-2"></i>
              <strong><%= @low_stock_count %></strong> items below reorder point
              <%= link_to 'View', low_stock_path, 
                  class: 'alert-link float-end' %>
            </div>
          <% end %>

          <!-- Pending POs -->
          <h6 class="text-muted mb-2">Open Purchase Orders</h6>
          <% if @pending_pos.any? %>
            <div class="list-group list-group-flush">
              <% @pending_pos.each do |po| %>
                <%= link_to inventory_purchase_order_path(po), 
                    class: 'list-group-item list-group-item-action px-0 py-2' do %>
                  <div class="d-flex justify-content-between">
                    <small>
                      <strong><%= po.po_number %></strong><br>
                      <%= po.supplier.name %>
                    </small>
                    <small class="text-end">
                      <%= po.receiving_percentage.round(0) %>%<br>
                      <span class="text-muted">
                        <%= po.expected_date.strftime('%b %d') %>
                      </span>
                    </small>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted small">No pending purchase orders</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-lightning me-2"></i>
            Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <%= link_to new_inventory_purchase_order_path, 
                  class: 'btn btn-outline-primary w-100' do %>
                <i class="bi bi-plus-circle me-2"></i>New Purchase Order
              <% end %>
            </div>
            <div class="col-md-3 mb-2">
              <%= link_to new_inventory_goods_receipt_path, 
                  class: 'btn btn-outline-success w-100' do %>
                <i class="bi bi-box-arrow-in-down me-2"></i>Receive Goods
              <% end %>
            </div>
            <div class="col-md-3 mb-2">
              <%= link_to new_inventory_stock_issue_path, 
                  class: 'btn btn-outline-danger w-100' do %>
                <i class="bi bi-box-arrow-right me-2"></i>Issue Stock
              <% end %>
            </div>
            <div class="col-md-3 mb-2">
              <%= link_to new_inventory_cycle_count_path, 
                  class: 'btn btn-outline-info w-100' do %>
                <i class="bi bi-clipboard-check me-2"></i>Schedule Count
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Stock Movement Chart
  const movementCtx = document.getElementById('stockMovementChart');
  if (movementCtx) {
    new Chart(movementCtx, {
      type: 'line',
      data: {
        labels: <%= raw @stock_movement_data.map { |d| d[:date] }.to_json %>,
        datasets: [{
          label: 'Receipts',
          data: <%= raw @stock_movement_data.map { |d| d[:receipts] }.to_json %>,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.4
        }, {
          label: 'Issues',
          data: <%= raw @stock_movement_data.map { |d| d[:issues] }.to_json %>,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Warehouse Distribution Chart
  const warehouseCtx = document.getElementById('warehouseDistributionChart');
  if (warehouseCtx) {
    new Chart(warehouseCtx, {
      type: 'doughnut',
      data: {
        labels: <%= raw @warehouse_stock_data.map { |d| d[:name] }.to_json %>,
        datasets: [{
          data: <%= raw @warehouse_stock_data.map { |d| d[:quantity] }.to_json %>,
          backgroundColor: [
            '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8',
            '#6c757d', '#343a40', '#e83e8c', '#fd7e14', '#20c997'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }
});
</script>
