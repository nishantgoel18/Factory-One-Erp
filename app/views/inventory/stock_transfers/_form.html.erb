<%= simple_form_for [:inventory, @stock_transfer] do |f| %>
<%= render 'layouts/error_messages', object: @stock_transfer %>
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Transfer Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <%= f.association :from_warehouse,
              collection: Warehouse.where(deleted: false, is_active: true).order(:name),
              label: 'From Warehouse',
              prompt: 'Select From Warehouse',
              input_html: { class: 'form-control', id: 'from_warehouse_select' } %>
        </div>
        
        <div class="col-md-6">
          <%= f.association :to_warehouse,
              collection: Warehouse.where(deleted: false, is_active: true).order(:name),
              label: 'To Warehouse',
              prompt: 'Select To Warehouse',
              input_html: { class: 'form-control', id: 'to_warehouse_select' } %>
        </div>
        
        <div class="col-md-12 mt-3">
          <%= f.input :note,
              as: :text,
              input_html: { class: 'form-control', rows: 2 } %>
        </div>
      </div>
      <%= f.input :status, as: :hidden, input_html: {value: StockTransfer::STATUS_DRAFT} %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Items to Transfer</h5>
      <button type="button" class="btn btn-sm btn-light" id="add-transfer-line">
        <i class="bi bi-plus-circle"></i> Add Item
      </button>
    </div>
    <div class="card-body">
      <div id="transfer-lines-container">
        <%= f.simple_fields_for :lines do |line_form| %>
          <%= render 'line_fields', f: line_form %>
        <% end %>
      </div>

      <template id="transfer-line-template">
        <%= f.simple_fields_for :lines, StockTransferLine.new, child_index: 'NEW_RECORD' do |line_form| %>
          <%= render 'line_fields', f: line_form %>
        <% end %>
      </template>
    </div>
  </div>

  <div class="d-flex justify-content-between">
    <%= link_to 'Cancel', inventory_stock_transfers_path, class: 'btn btn-secondary' %>
    <%= f.submit 'Save Transfer', class: 'btn btn-primary' %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add new line item
  document.getElementById('add-transfer-line').addEventListener('click', function() {
    const template = document.getElementById('transfer-line-template');
    const content = template.content.cloneNode(true);
    const html = content.firstElementChild.outerHTML.replace(/NEW_RECORD/g, new Date().getTime());
    document.getElementById('transfer-lines-container').insertAdjacentHTML('beforeend', html);
  });
  
  // Remove line item
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-transfer-line')) {
      const lineItem = e.target.closest('.transfer-line-row');
      const destroyInput = lineItem.querySelector('input[name*="_destroy"]');
      
      if (destroyInput) {
        destroyInput.value = '1';
        lineItem.style.display = 'none';
      } else {
        lineItem.remove();
      }
    }
  });
});
</script>
