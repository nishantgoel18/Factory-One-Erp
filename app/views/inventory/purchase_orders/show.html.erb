<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Purchase Orders</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
        <a class="breadcrumb-item" href="/inventory/dashboard">Inventory Management</a>
        <a class="breadcrumb-item" href="/inventory/purchase_orders">Purchase Orders</a>

        <span class="breadcrumb-item active">View Purchase Order</span>
      </nav>
    </div>
  </div>
  <div class="d-flex align-items-start justify-content-between mb-1">
    <div>
      <h2 class="mb-2">
        <i class="bi bi-file-earmark-text me-2"></i>
        <%= @purchase_order.po_number %>
      </h2>
      <p class="text-muted mb-0">
        Created on <%= @purchase_order.created_at.strftime('%B %d, %Y at %I:%M %p') %>
        <% if @purchase_order.created_by %>
          by <%= @purchase_order.created_by.full_name %>
        <% end %>
      </p>
    </div>
    <div class="text-end">
      <%= render 'shared/status_badge', status: @purchase_order.status %>
      
      <!-- Actions Dropdown -->
      <% po = @purchase_order %>
      <div class="btn-group ms-2">
        <% if po.can_edit? %>
          <%= link_to edit_inventory_purchase_order_path(po), 
              title: 'Edit', class: 'btn btn-sm btn-outline-primary' do %>
            Edit
          <% end %>
        <% end %>
        <% if po.can_confirm? %>
          <%= link_to confirm_inventory_purchase_order_path(po), 
              method: :post,
              data: { confirm: 'Confirm this Purchase Order? It will be sent to the supplier.' },
              class: 'btn btn-sm btn-outline-primary' do %>
             Confirm PO
          <% end %>
        <% end %>

        <% if po.can_receive? %>
          <%= link_to from_po_inventory_goods_receipts_path(po_id: po.id), 
              class: 'btn btn-sm btn-outline-primary' do %>
             Receive Goods (GRN)
          <% end %>
        <% end %>

        <%= link_to print_inventory_purchase_order_path(po, format: :pdf), 
            target: '_blank',
            class: 'btn btn-sm btn-outline-primary' do %>
          <i class="bi bi-printer me-2"></i> Print / Download PDF
        <% end %>

        <% if po.can_close? %>
          <%= link_to close_inventory_purchase_order_path(po), 
              method: :post,
              data: { confirm: 'Close this PO? All items are received.' },
              class: 'btn btn-sm btn-outline-primary' do %>
            <i class="bi bi-lock me-2"></i> Close PO
          <% end %>
        <% end %>

        <% if po.can_cancel? %>
          <%= link_to cancel_inventory_purchase_order_path(po), 
              method: :post,
              data: { confirm: 'Cancel this PO? This action cannot be undone.' },
              class: 'btn-sm btn btn-outline-danger' do %>
            Cancel PO
          <% end %>
        <% end %>
      
        <% if po.can_delete? %>
          <%= link_to inventory_purchase_order_path(po), 
              method: :delete,
              data: { confirm: 'Delete this PO? This cannot be undone.' },
              class: 'btn-sm btn btn-outline-danger' do %>
            Delete
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <%= render 'inventory/purchase_orders/rfq_traceability', purchase_order: @purchase_order %>

  <div class="row">
    <!-- Left Column: PO Details -->
    <div class="col-md-8">
      <!-- PO Information -->
      <div class="card mb-4">
        <div class="card-header bg-primary d-flex align-items-center">
          <h5 class="mb-0">Purchase Order Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row mb-0">
                <dt class="col-sm-5">Supplier:</dt>
                <dd class="col-sm-7">
                  <i class="bi bi-building me-1"></i>
                  <strong><%= @purchase_order.supplier.name %></strong>
                </dd>

                <dt class="col-sm-5">Warehouse:</dt>
                <dd class="col-sm-7">
                  <%= @purchase_order.warehouse&.name || 'Not specified' %>
                </dd>

                <dt class="col-sm-5">Order Date:</dt>
                <dd class="col-sm-7">
                  <%= @purchase_order.order_date.strftime('%B %d, %Y') %>
                </dd>

                <dt class="col-sm-5">Expected Date:</dt>
                <dd class="col-sm-7">
                  <% if @purchase_order.expected_date %>
                    <%= @purchase_order.expected_date.strftime('%B %d, %Y') %>
                    <% if @purchase_order.expected_date < Date.current && 
                          ['CONFIRMED', 'PARTIALLY_RECEIVED'].include?(@purchase_order.status) %>
                      <span class="text-white badge bg-danger ms-1">Overdue</span>
                    <% end %>
                  <% else %>
                    <span class="text-muted">Not set</span>
                  <% end %>
                </dd>
              </dl>
            </div>

            <div class="col-md-6">
              <dl class="row mb-0">
                <dt class="col-sm-5">Currency:</dt>
                <dd class="col-sm-7"><%= @purchase_order.currency %></dd>

                <dt class="col-sm-5">Payment Terms:</dt>
                <dd class="col-sm-7">
                  <%= PurchaseOrder::PAYMENT_TERMS[@purchase_order.payment_terms] || 'Not specified' %>
                </dd>

                <dt class="col-sm-5">Shipping Method:</dt>
                <dd class="col-sm-7">
                  <%= @purchase_order.shipping_method || 'Not specified' %>
                </dd>

                <% if @purchase_order.confirmed_at %>
                  <dt class="col-sm-5">Confirmed:</dt>
                  <dd class="col-sm-7">
                    <%= @purchase_order.confirmed_at.strftime('%B %d, %Y') %>
                    <% if @purchase_order.confirmed_by %>
                      <br><small class="text-muted">by <%= @purchase_order.confirmed_by.full_name %></small>
                    <% end %>
                  </dd>
                <% end %>
              </dl>
            </div>

            <% if @purchase_order.notes.present? %>
              <div class="col-12 mt-3">
                <dt>Notes:</dt>
                <dd class="border-start border-3 border-primary ps-3 mb-0">
                  <%= simple_format(@purchase_order.notes) %>
                </dd>
              </div>
            <% end %>

            <% if @purchase_order.internal_notes.present? %>
              <div class="col-12 mt-3">
                <dt>Internal Notes:</dt>
                <dd class="border-start border-3 border-warning ps-3 mb-0 p-l-10 bg-warning bg-opacity-10 py-2 text-white">
                  <%= simple_format(@purchase_order.internal_notes) %>
                </dd>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Line Items -->
      <div class="card mb-4">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-list-check"></i>
            Line Items
            <span class="badge bg-secondary"><%= @purchase_order.lines.count %></span>
          </h5>
          
          <% if @purchase_order.from_rfq? %>
            <%= full_traceability_badge(@purchase_order) %>
          <% end %>
        </div>
        
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead class="table-light">
                <tr>
                  <th width="8%">Line</th>
                  <th width="12%">Product Code</th>
                  <th>Description</th>
                  <th width="10%" class="text-center">Ordered Qty</th>
                  <th width="10%" class="text-center">Received</th>
                  <th width="12%" class="text-end">Unit Price</th>
                  <th width="12%" class="text-end">Line Total</th>
                  <th width="10%">Status</th>
                </tr>
              </thead>
              <tbody>
                <% @purchase_order.lines.each_with_index do |line, index| %>
                  <tr class="<%= 'table-info' if line.from_rfq? %>">
                    <!-- Line Number -->
                    <td class="text-center">
                      <span class="badge bg-secondary"><%= index + 1 %></span>
                      <% if line.from_rfq? %>
                        <br>
                        <small class="badge bg-info mt-1">
                          <i class="bi bi-link-45deg"></i> RFQ
                        </small>
                      <% end %>
                    </td>
                    
                    <!-- Product Code -->
                    <td>
                      <code class="text-primary"><%= line.product.sku %></code>
                      
                      <!-- RFQ Reference -->
                      <%= po_line_rfq_reference(line) %>
                    </td>
                    
                    <!-- Description -->
                    <td>
                      <strong><%= line.product.name %></strong>
                      
                      <!-- Line Notes -->
                      <% if line.line_note.present? %>
                        <br>
                        <small class="text-muted">
                          <%= truncate(line.line_note, length: 80) %>
                        </small>
                      <% end %>
                      
                      <!-- Traceability Chain -->
                      <% if line.from_rfq? %>
                        <br>
                        <%= traceability_chain(line) %>
                      <% end %>
                    </td>
                    
                    <!-- Ordered Quantity -->
                    <td class="text-center">
                      <strong><%= number_with_delimiter(line.ordered_qty) %></strong>
                      <br>
                      <small class="text-muted"><%= line.uom.symbol %></small>
                    </td>
                    
                    <!-- Received Quantity -->
                    <td class="text-center">
                      <% if line.received_qty > 0 %>
                        <span class="text-success fw-bold">
                          <%= number_with_delimiter(line.received_qty) %>
                        </span>
                        <br>
                        <small class="text-muted">
                          <%= number_to_percentage((line.received_qty / line.ordered_qty * 100), precision: 0) %>
                        </small>
                      <% else %>
                        <span class="text-muted">0</span>
                      <% end %>
                    </td>
                    
                    <!-- Unit Price -->
                    <td class="text-end">
                      <strong><%= number_to_currency(line.unit_price) %></strong>
                      
                      <!-- Price Comparison with RFQ Target -->
                      <%= po_line_price_comparison(line) %>
                      
                      <!-- Vendor Quote Score -->
                      <%= po_line_quote_score(line) %>
                    </td>
                    
                    <!-- Line Total -->
                    <td class="text-end">
                      <strong class="fs-5"><%= number_to_currency(line.line_total) %></strong>
                      
                      <% if line.tax_amount > 0 %>
                        <br>
                        <small class="text-muted">
                          + <%= number_to_currency(line.tax_amount) %> tax
                        </small>
                      <% end %>
                    </td>
                    
                    <!-- Status -->
                    <td>
                      <% case line.line_status %>
                      <% when 'OPEN', 'PENDING' %>
                        <span class="badge bg-warning text-dark">
                          <i class="bi bi-hourglass-split"></i>
                          <%= line.line_status.titleize %>
                        </span>
                      <% when 'PARTIALLY_RECEIVED' %>
                        <span class="badge bg-info">
                          <i class="bi bi-arrow-down-circle"></i>
                          Partial
                        </span>
                      <% when 'FULLY_RECEIVED' %>
                        <span class="badge bg-success">
                          <i class="bi bi-check-circle"></i>
                          Received
                        </span>
                      <% when 'CLOSED' %>
                        <span class="badge bg-secondary">
                          <i class="bi bi-x-circle"></i>
                          Closed
                        </span>
                      <% else %>
                        <span class="badge bg-secondary">
                          <%= line.line_status %>
                        </span>
                      <% end %>
                      
                      <!-- Expected Delivery -->
                      <% if line.expected_delivery_date.present? %>
                        <br>
                        <small class="text-muted">
                          <i class="bi bi-calendar-event"></i>
                          <%= line.expected_delivery_date.strftime('%b %d') %>
                        </small>
                      <% end %>
                    </td>
                  </tr>
                  
                  <!-- Expanded Details Row (Optional - toggle with JS) -->
                  <% if line.from_rfq? && line.vendor_quote.present? %>
                    <tr class="collapse" id="line-details-<%= line.id %>">
                      <td colspan="8" class="bg-light">
                        <div class="p-3">
                          <h6 class="text-muted mb-3">
                            <i class="bi bi-info-circle"></i>
                            RFQ Source Details
                          </h6>
                          
                          <div class="row">
                            <!-- RFQ Item Info -->
                            <div class="col-md-6">
                              <dl class="row mb-0">
                                <dt class="col-sm-5 text-muted">RFQ Line:</dt>
                                <dd class="col-sm-7">
                                  <code><%= line.rfq_item.line_number %></code>
                                </dd>
                                
                                <dt class="col-sm-5 text-muted">Target Price:</dt>
                                <dd class="col-sm-7">
                                  <%= number_to_currency(line.rfq_item.target_unit_price) %>
                                </dd>
                                
                                <dt class="col-sm-5 text-muted">Required Date:</dt>
                                <dd class="col-sm-7">
                                  <%= line.rfq_item.required_delivery_date&.strftime('%B %d, %Y') || 'Not specified' %>
                                </dd>
                              </dl>
                            </div>
                            
                            <!-- Vendor Quote Info -->
                            <div class="col-md-6">
                              <dl class="row mb-0">
                                <dt class="col-sm-5 text-muted">Quote Price:</dt>
                                <dd class="col-sm-7">
                                  <%= number_to_currency(line.vendor_quote.unit_price) %>
                                </dd>
                                
                                <dt class="col-sm-5 text-muted">Lead Time:</dt>
                                <dd class="col-sm-7">
                                  <%= line.vendor_quote.lead_time_days %> days
                                </dd>
                                
                                <dt class="col-sm-5 text-muted">Quote Score:</dt>
                                <dd class="col-sm-7">
                                  <span class="badge bg-success">
                                    <%= line.vendor_quote.overall_score&.round(1) || 'N/A' %>
                                  </span>
                                </dd>
                              </dl>
                            </div>
                          </div>
                          
                          <!-- Quote Notes -->
                          <% if line.vendor_quote.delivery_notes.present? %>
                            <div class="mt-2">
                              <strong class="text-muted">Delivery Notes:</strong>
                              <p class="mb-0 text-muted small">
                                <%= line.vendor_quote.delivery_notes %>
                              </p>
                            </div>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                <% end %>
              </tbody>
              
              <!-- Totals Footer -->
              <tfoot class="table-light">
                <tr>
                  <th colspan="3" class="text-end">Subtotal:</th>
                  <th class="text-center">
                    <%= number_with_delimiter(@purchase_order.total_ordered_qty) %>
                  </th>
                  <th class="text-center">
                    <%= number_with_delimiter(@purchase_order.total_received_qty) %>
                  </th>
                  <th></th>
                  <th class="text-end">
                    <%= number_to_currency(@purchase_order.subtotal) %>
                  </th>
                  <th></th>
                </tr>
                
                <% if @purchase_order.tax_amount > 0 %>
                  <tr>
                    <th colspan="6" class="text-end">Tax:</th>
                    <th class="text-end">
                      <%= number_to_currency(@purchase_order.tax_amount) %>
                    </th>
                    <th></th>
                  </tr>
                <% end %>
                
                <% if @purchase_order.shipping_cost > 0 %>
                  <tr>
                    <th colspan="6" class="text-end">Shipping:</th>
                    <th class="text-end">
                      <%= number_to_currency(@purchase_order.shipping_cost) %>
                    </th>
                    <th></th>
                  </tr>
                <% end %>
                
                <tr class="table-primary">
                  <th colspan="6" class="text-end fs-5">Total Amount:</th>
                  <th class="text-end fs-5">
                    <strong><%= number_to_currency(@purchase_order.total_amount) %></strong>
                  </th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <!-- Footer Info -->
        <% if @purchase_order.from_rfq? %>
          <div class="card-footer bg-light">
            <div class="row align-items-center">
              <div class="col-md-6">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  Lines with <span class="badge bg-info">RFQ</span> badge are linked to 
                  <%= link_to "RFQ #{@purchase_order.rfq.rfq_number}", 
                      rfq_path(@purchase_order.rfq), 
                      class: "fw-bold" %>
                </small>
              </div>
              <div class="col-md-6 text-end">
                <button class="btn btn-sm btn-outline-secondary" 
                        data-bs-toggle="collapse" 
                        data-bs-target="[id^='line-details-']">
                  <i class="bi bi-arrows-expand"></i>
                  Toggle RFQ Details
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <style>
        .table-hover tbody tr.table-info:hover {
          background-color: #d1ecf1 !important;
        }
        
        tr.collapse {
          display: none;
        }
        
        tr.collapse.show {
          display: table-row;
        }
      </style>

      <script>
        // Toggle all details rows
        document.addEventListener('DOMContentLoaded', function() {
          const toggleButton = document.querySelector('[data-bs-target="[id^=\'line-details-\']"]');
          if (!toggleButton) return;
          
          toggleButton.addEventListener('click', function() {
            const detailRows = document.querySelectorAll('[id^="line-details-"]');
            detailRows.forEach(row => {
              row.classList.toggle('show');
            });
            
            const icon = this.querySelector('i');
            if (icon.classList.contains('bi-arrows-expand')) {
              icon.classList.replace('bi-arrows-expand', 'bi-arrows-collapse');
              this.innerHTML = '<i class="bi bi-arrows-collapse"></i> Hide RFQ Details';
            } else {
              icon.classList.replace('bi-arrows-collapse', 'bi-arrows-expand');
              this.innerHTML = '<i class="bi bi-arrows-expand"></i> Toggle RFQ Details';
            }
          });
        });
      </script>

      <!-- Related Goods Receipts -->
      <% if @purchase_order.goods_receipts.any? %>
        <div class="card">
          <div class="card-header bg-primary d-flex align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-box-seam me-2"></i>
              Goods Receipts (GRNs)
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>GRN Number</th>
                    <th>Receipt Date</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @purchase_order.goods_receipts.each do |grn| %>
                    <tr>
                      <td><%= grn.reference_no %></td>
                      <td><%= grn.receipt_date.strftime('%b %d, %Y') %></td>
                      <td><%= render 'shared/status_badge', status: grn.status %></td>
                      <td class="text-end">
                        <%= link_to 'View', inventory_goods_receipt_path(grn), 
                            class: 'btn btn-sm btn-outline-primary' %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Right Column: Summary & Stats -->
    <div class="col-md-4">
      <!-- Receiving Progress -->
      <% if ['CONFIRMED', 'PARTIALLY_RECEIVED', 'RECEIVED'].include?(@purchase_order.status) %>
        <div class="card mb-4">
          <div class="card-header bg-primary d-flex align-items-center">
            <h6 class="mb-0">Receiving Progress</h6>
          </div>
          <div class="card-body">
            <div class="progress mb-3" style="height: 30px;">
              <div class="progress-bar <%= @purchase_order.receiving_percentage == 100 ? 'bg-success' : 'bg-primary' %>" 
                   role="progressbar" 
                   style="width: <%= @purchase_order.receiving_percentage %>%">
                <strong><%= @purchase_order.receiving_percentage.round(0) %>%</strong>
              </div>
            </div>

            <dl class="row mb-0">
              <dt class="col-6">Total Ordered:</dt>
              <dd class="col-6 text-end"><%= @purchase_order.total_ordered_qty.to_i %></dd>

              <dt class="col-6">Total Received:</dt>
              <dd class="col-6 text-end text-success">
                <strong><%= @purchase_order.total_received_qty.to_i %></strong>
              </dd>

              <dt class="col-6 border-top pt-2">Outstanding:</dt>
              <dd class="col-6 text-end border-top pt-2 text-danger">
                <strong><%= @purchase_order.outstanding_qty.to_i %></strong>
              </dd>
            </dl>
          </div>
        </div>
      <% end %>

      <!-- Supplier Info -->
      <div class="card">
        <div class="card-header bg-primary d-flex align-items-center">
          <h6 class="mb-0">Supplier Information</h6>
        </div>
        <div class="card-body">
          <h6 class="text-primary mb-2">
            <i class="bi bi-building"></i>
            <%= @purchase_order.supplier.name %>
          </h6>

          <% if @purchase_order.supplier.email.present? %>
            <p class="mb-1">
              <i class="bi bi-envelope me-1"></i>
              <%= mail_to @purchase_order.supplier.email, @purchase_order.supplier.email, 
                  class: 'text-decoration-none' %>
            </p>
          <% end %>

          <% if @purchase_order.supplier.phone.present? %>
            <p class="mb-1">
              <i class="bi bi-telephone me-1"></i>
              <%= @purchase_order.supplier.phone %>
            </p>
          <% end %>

          <hr>

          <dl class="row mb-0 small">
            <dt class="col-7">Lead Time:</dt>
            <dd class="col-5 text-end"><%= @purchase_order.supplier.lead_time_days %> days</dd>

            <dt class="col-7">On-Time Delivery:</dt>
            <dd class="col-5 text-end">
              <span class="text-white badge <%= @purchase_order.supplier.on_time_delivery_rate >= 95 ? 'bg-success' : 'bg-warning' %>">
                <%= @purchase_order.supplier.on_time_delivery_rate.round(0) %>%
              </span>
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>
