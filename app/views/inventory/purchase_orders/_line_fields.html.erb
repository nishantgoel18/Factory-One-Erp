<%# app/views/inventory/purchase_orders/_line_fields.html.erb %>

<div class="line-item-row border rounded p-3 mb-3 <%= 'bg-primary' if f.object.persisted? %>">
  <div class="row align-items-start">
    <!-- Product -->
    <div class="col-md-4">
      <%= f.association :product,
          collection: Product.where(deleted: false, is_active: true).order(:name),
          label_method: lambda { |p| "#{p.sku} - #{p.name}" },
          value_method: :id,
          include_blank: 'Select Product',
          label: 'Product',
          input_html: { class: 'form-select form-control' } %>
    </div>

    <!-- Ordered Qty -->
    <div class="col-md-2">
      <%= f.input :ordered_qty,
          label: 'Quantity',
          input_html: { class: 'form-control form-control', min: 0, step: 0.01 } %>
    </div>

    <!-- UoM -->
    <div class="col-md-2">
      <%= f.association :uom,
          collection: UnitOfMeasure.non_deleted.order(:name),
          label_method: :symbol,
          value_method: :id,
          label: 'Unit',
          input_html: { class: 'form-select form-control' } %>
    </div>

    <!-- Unit Price -->
    <div class="col-md-2">
      <%= f.input :unit_price,
          label: 'Unit Price',
          input_html: { class: 'form-control form-control', min: 0, step: 0.01 } %>
    </div>

    <!-- Line Total (Display only) -->
    <div class="col-md-1">
      <label class="form-label">Total</label>
      <div class="fw-bold line-total-display">$0.00</div>
    </div>

    <!-- Remove Button -->
    <div class="col-md-1 text-end">
      <label class="form-label">&nbsp;</label>
      <button type="button" class="btn btn-sm btn-outline-danger remove-line-item w-100">
        Delete
      </button>
      <%= f.input :_destroy, as: :hidden, input_html: { value: false } %>
    </div>

    <!-- Optional: Tax Code -->
    <div class="col-md-3 mt-2">
      <%= f.association :tax_code,
          collection: TaxCode.active.order(:code),
          label_method: lambda { |tc| "#{tc.code} (#{(tc.rate * 100).round(2)}%)" },
          value_method: :id,
          include_blank: 'No Tax',
          label: 'Tax Code (Optional)',
          input_html: { class: 'form-select form-control' } %>
    </div>

    <!-- Line Note -->
    <div class="col-md-6 mt-2">
      <%= f.input :line_note,
          label: 'Line Notes',
          input_html: { class: 'form-control form-control', rows: 1, placeholder: 'Optional notes for this line...' } %>
    </div>

    <!-- Expected Delivery (Optional) -->
    <div class="col-md-3 mt-2">
      <%= f.input :expected_delivery_date,
          as: :date,
          label: 'Expected Delivery',
          input_html: { class: 'form-control form-control' },
          hint: 'Override PO expected date' %>
    </div>
  </div>

  <% if f.object.persisted? && f.object.received_qty > 0 %>
    <div class="alert alert-info alert-sm mt-2 mb-0">
      <i class="bi bi-info-circle me-1"></i>
      <strong>Received:</strong> <%= f.object.received_qty %> / <%= f.object.ordered_qty %>
      (<%= f.object.receiving_percentage.round(0) %>%)
    </div>
  <% end %>
</div>