<%# app/views/inventory/purchase_orders/index.html.erb %>
<div class="main-content">
    <%= render 'layouts/alerts' %>

    <div class="page-header">
        <h2 class="header-title">Purchase Orders</h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
                <a class="breadcrumb-item" href="/inventory/dashboard">Inventory Management</a>
                <span class="breadcrumb-item active">Purchase Orders</span>
            </nav>
        </div>
    </div>
      <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        
        <p class="text-muted mb-0">Manage your purchase orders and vendor purchases</p>
      </div>
      <%= link_to new_inventory_purchase_order_path, class: 'btn btn-primary' do %>
        <i class="bi bi-plus-circle me-1"></i>
        New Purchase Order
      <% end %>
    </div>

    <!-- Filters & Search -->
    <div class="card mb-4">
      <div class="card-body">
        <%= form_with url: inventory_purchase_orders_path, method: :get, class: 'row g-3' do |f| %>
          <div class="col-md-3">
            <%= f.label :search, 'Search', class: 'form-label' %>
            <%= f.text_field :search, 
                value: params[:search], 
                class: 'form-control', 
                placeholder: 'PO Number or Notes...' %>
          </div>

          <div class="col-md-2">
            <%= f.label :supplier_id, 'Supplier', class: 'form-label' %>
            <%= f.select :supplier_id, 
                options_from_collection_for_select(Supplier.active.order(:name), :id, :name, params[:supplier_id]),
                { include_blank: 'All Suppliers' },
                { class: 'form-control' } %>
          </div>

          <div class="col-md-2">
            <%= f.label :status, 'Status', class: 'form-label' %>
            <%= f.select :status,
                options_for_select(PurchaseOrder::STATUSES.map { |s| [s.titleize, s] }, params[:status]),
                { include_blank: 'All Statuses' },
                { class: 'form-control' } %>
          </div>

          <div class="col-md-2">
            <%= f.label :from_date, 'From Date', class: 'form-label' %>
            <%= f.date_field :from_date, value: params[:from_date], class: 'form-control' %>
          </div>

          <div class="col-md-2">
            <%= f.label :to_date, 'To Date', class: 'form-label' %>
            <%= f.date_field :to_date, value: params[:to_date], class: 'form-control' %>
          </div>

          <div class="col-md-1 d-flex align-items-end">
            <%= f.submit 'Filter', class: 'btn btn-secondary w-100' %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="row mb-4">
      <div class="col-md-3">
        <%= link_to inventory_purchase_orders_path(status: 'DRAFT'), class: 'text-decoration-none' do %>
          <div class="card border-warning">
            <div class="card-body">
              <h5 class="card-title text-warning">
                <i class="bi bi-file-earmark-text"></i> Draft POs
              </h5>
              <h3 class="mb-0"><%= PurchaseOrder.draft.count %></h3>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-md-3">
        <%= link_to open_pos_inventory_purchase_orders_path, class: 'text-decoration-none' do %>
          <div class="card border-primary">
            <div class="card-body">
              <h5 class="card-title text-primary">
                <i class="bi bi-hourglass-split"></i> Open POs
              </h5>
              <h3 class="mb-0"><%= PurchaseOrder.open_pos.count %></h3>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-md-3">
        <%= link_to overdue_inventory_purchase_orders_path, class: 'text-decoration-none' do %>
          <div class="card border-danger">
            <div class="card-body">
              <h5 class="card-title text-danger">
                <i class="bi bi-exclamation-triangle"></i> Overdue
              </h5>
              <h3 class="mb-0">
                <%= PurchaseOrder.active
                      .where('expected_date < ?', Date.current)
                      .where(status: ['CONFIRMED', 'PARTIALLY_RECEIVED'])
                      .count %>
              </h3>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-md-3">
        <%= link_to inventory_purchase_orders_path(status: 'RECEIVED'), class: 'text-decoration-none' do %>
          <div class="card border-success">
            <div class="card-body">
              <h5 class="card-title text-success">
                <i class="bi bi-check-circle"></i> Received
              </h5>
              <h3 class="mb-0">
                <%= PurchaseOrder.where(status: 'RECEIVED', deleted: false).count %>
              </h3>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- PO Table -->
    <div class="card">
      <div class="card-body">
        <% if @purchase_orders.any? %>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>PO Number</th>
                  <th>Supplier</th>
                  <th>Order Date</th>
                  <th>Expected Date</th>
                  <th>Status</th>
                  <th class="text-end">Total Amount</th>
                  <th class="text-center">Progress</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @purchase_orders.each do |po| %>
                  <tr>
                    <td>
                      <%= link_to po.po_number, inventory_purchase_order_path(po), 
                          class: 'fw-bold text-decoration-none' %>
                    </td>
                    <td>
                      <i class="bi bi-building me-1"></i>
                      <%= po.supplier.name %>
                    </td>
                    <td>
                      <i class="bi bi-calendar me-1"></i>
                      <%= po.order_date.strftime('%b %d, %Y') %>
                    </td>
                    <td>
                      <i class="bi bi-calendar-check me-1"></i>
                      <%= po.expected_date&.strftime('%b %d, %Y') || 'N/A' %>
                      <% if po.expected_date && po.expected_date < Date.current && 
                            ['CONFIRMED', 'PARTIALLY_RECEIVED'].include?(po.status) %>
                        <span class="badge bg-danger ms-1">Overdue</span>
                      <% end %>
                    </td>
                    <td>
                      <%= render 'shared/status_badge', status: po.status %>
                    </td>
                    <td class="text-end">
                      <strong><%= number_to_currency(po.total_amount, unit: po.currency == 'CAD' ? 'CAD $' : '$') %></strong>
                    </td>
                    <td class="text-center" style="width: 150px;">
                      <% if ['CONFIRMED', 'PARTIALLY_RECEIVED', 'RECEIVED'].include?(po.status) %>
                        <div class="progress" style="height: 20px;">
                          <div class="progress-bar <%= po.receiving_percentage == 100 ? 'bg-success' : 'bg-primary' %>" 
                               role="progressbar" 
                               style="width: <%= po.receiving_percentage %>%"
                               aria-valuenow="<%= po.receiving_percentage %>" 
                               aria-valuemin="0" 
                               aria-valuemax="100">
                            <%= po.receiving_percentage.round(0) %>%
                          </div>
                        </div>
                        <small class="text-muted">
                          <%= po.total_received_qty.to_i %> / <%= po.total_ordered_qty.to_i %>
                        </small>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td class="text-end">
                        
                        
                      <div class="btn-group" role="group">
                        <%= link_to inventory_purchase_order_path(po), class: 'btn btn-sm btn-outline-primary' do %>
                          View
                        <% end %>
                        
                        <% if po.can_edit? %>
                          <%= link_to edit_inventory_purchase_order_path(po), 
                              title: 'Edit', class: 'btn btn-sm btn-outline-primary' do %>
                            Edit
                          <% end %>
                        <% end %>
                        <% if po.can_confirm? %>
                          <%= link_to confirm_inventory_purchase_order_path(po), 
                              method: :post,
                              data: { confirm: 'Confirm this Purchase Order? It will be sent to the supplier.' },
                              class: 'btn btn-sm btn-outline-primary' do %>
                            <i class="bi bi-check-circle me-2 text-success"></i> Confirm PO
                          <% end %>
                        <% end %>

                        <% if po.can_receive? %>
                          <%= link_to from_po_inventory_goods_receipts_path(po_id: po.id), 
                              class: 'btn btn-sm btn-outline-primary' do %>
                            <i class="bi bi-box-seam me-2 text-primary"></i> Receive Goods (GRN)
                          <% end %>
                        <% end %>

                        <%= link_to print_inventory_purchase_order_path(po, format: :pdf), 
                            target: '_blank',
                            class: 'btn btn-sm btn-outline-primary' do %>
                          <i class="bi bi-printer me-2"></i> Print / Download PDF
                        <% end %>

                        <% if po.can_close? %>
                          <%= link_to close_inventory_purchase_order_path(po), 
                              method: :post,
                              data: { confirm: 'Close this PO? All items are received.' },
                              class: 'btn btn-sm btn-outline-primary' do %>
                            <i class="bi bi-lock me-2"></i> Close PO
                          <% end %>
                        <% end %>

                        <% if po.can_cancel? %>
                          <%= link_to cancel_inventory_purchase_order_path(po), 
                              method: :post,
                              data: { confirm: 'Cancel this PO? This action cannot be undone.' },
                              class: 'btn btn-sm btn-outline-danger' do %>
                            <i class="bi bi-x-circle me-2"></i> Cancel PO
                          <% end %>
                        <% end %>
                      
                        <% if po.can_delete? %>
                          <%= link_to inventory_purchase_order_path(po), 
                              method: :delete,
                              data: { confirm: 'Delete this PO? This cannot be undone.' },
                              class: 'btn btn-sm btn-outline-danger' do %>
                            <i class="bi bi-trash me-2"></i>Delete
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
          Showing <%= @purchase_orders.offset_value + 1 %> to 
          <%= [@purchase_orders.offset_value + @purchase_orders.length, @purchase_orders.total_count].min %> 
          of <%= @purchase_orders.total_count %> purchase orders
        </div>
        <%= paginate @purchase_orders %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h5 class="mt-3 text-muted">No purchase orders found</h5>
        <p class="text-muted">Start by creating your first purchase order</p>
        <%= link_to 'Create Purchase Order', new_inventory_purchase_order_path, 
            class: 'btn btn-primary mt-2' %>
      </div>
    <% end %>
  </div>
    </div>
  </div>
</div>