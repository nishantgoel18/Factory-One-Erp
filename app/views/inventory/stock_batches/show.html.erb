<!-- app/views/stock_batches/show.html.erb -->

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Stock Batchs</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
        <a class="breadcrumb-item" href="/inventory/dashboard">Inventory Management</a>
        <a class="breadcrumb-item" href="/inventory/stock_batches">Stock Batches</a>

        <span class="breadcrumb-item active">View Stock Batch</span>
      </nav>
    </div>
  </div>
  
  <!-- Header with Actions -->
  <div class="row mb-4">
    <div class="col-md-8">
      
      <h2 class="mb-0">
        <i class="fas fa-barcode me-2"></i>
        Batch: <%= @stock_batch.batch_number %>
      </h2>
    </div>
    <div class="col-md-4 text-end">
      <%= link_to edit_inventory_stock_batch_path(@stock_batch), class: "btn btn-primary me-2" do %>
        <i class="fas fa-edit me-1"></i> Edit
      <% end %>
      <%= link_to inventory_stock_batch_path(@stock_batch), 
          method: :delete,
          data: { confirm: "Are you sure? This will permanently delete this batch." },
          class: "btn btn-danger" do %>
        <i class="fas fa-trash me-1"></i> Delete
      <% end %>
    </div>
  </div>

  <!-- Status Alerts -->
  <% if @expiry_status.present? %>
    <div class="row mb-4">
      <div class="col-12">
        <% if @expiry_status == 'expired' %>
          <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
              <strong>Batch Expired!</strong><br>
              <%= @expiry_message %>
            </div>
          </div>
        <% elsif @expiry_status == 'expiring_soon' %>
          <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fas fa-exclamation-circle fa-2x me-3"></i>
            <div>
              <strong>Expiring Soon!</strong><br>
              <%= @expiry_message %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="row">
    
    <!-- Left Column -->
    <div class="col-md-8">
      
      <!-- Basic Information Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Batch Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Batch Number</label>
              <div class="h5"><%= @stock_batch.batch_number %></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Product</label>
              <div>
                <strong><%= @stock_batch.product.sku %></strong><br>
                <%= @stock_batch.product.name %>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Supplier Batch Reference</label>
              <div><%= @stock_batch.supplier_batch_ref.presence || '-' %></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Supplier Lot Number</label>
              <div><%= @stock_batch.supplier_lot_number.presence || '-' %></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dates Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>
            Dates
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Manufacture Date</label>
              <div class="h6">
                <% if @stock_batch.manufacture_date.present? %>
                  <%= @stock_batch.manufacture_date.strftime('%B %d, %Y') %>
                <% else %>
                  <span class="text-muted">Not specified</span>
                <% end %>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Expiry Date</label>
              <div class="h6">
                <% if @stock_batch.expiry_date.present? %>
                  <%= @stock_batch.expiry_date.strftime('%B %d, %Y') %>
                  <% days_to_expire = (@stock_batch.expiry_date - Date.today).to_i %>
                  <% if days_to_expire < 0 %>
                    <br><small class="text-danger">Expired <%= days_to_expire.abs %> days ago</small>
                  <% elsif days_to_expire <= 30 %>
                    <br><small class="text-warning">Expires in <%= days_to_expire %> days</small>
                  <% else %>
                    <br><small class="text-success">Expires in <%= days_to_expire %> days</small>
                  <% end %>
                <% else %>
                  <span class="text-muted">No expiry</span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quality & Certification Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-certificate me-2"></i>
            Quality & Certification
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Certificate Number</label>
              <div><%= @stock_batch.certificate_number.presence || '-' %></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small mb-1">Quality Status</label>
              <div>
                <% if @stock_batch.quality_status.present? %>
                  <% badge_class = case @stock_batch.quality_status
                      when 'APPROVED' then 'bg-success'
                      when 'PENDING' then 'bg-warning text-dark'
                      when 'REJECTED' then 'bg-danger'
                      when 'ON_HOLD' then 'bg-secondary'
                      else 'bg-info'
                    end %>
                  <span class="badge <%= badge_class %>">
                    <%= @stock_batch.quality_status.titleize %>
                  </span>
                <% else %>
                  <span class="text-muted">Not specified</span>
                <% end %>
              </div>
            </div>
          </div>
          
          <% if @stock_batch.notes.present? %>
            <div class="mt-3">
              <label class="text-muted small mb-1">Notes</label>
              <div class="p-3 bg-light rounded">
                <%= simple_format(@stock_batch.notes) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Stock by Location Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fas fa-map-marker-alt me-2"></i>
            Stock by Location
          </h5>
        </div>
        <div class="card-body">
          <% if @stock_by_location.any? %>
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Location</th>
                    <th class="text-end">Quantity</th>
                  </tr>
                </thead>
                <tbody>
                  <% @stock_by_location.each do |location_stock| %>
                    <tr>
                      <td><%= location_stock.location_name %></td>
                      <td class="text-end">
                        <strong class="text-success">
                          <%= number_with_delimiter(location_stock.total_qty, delimiter: ',') %>
                        </strong>
                        <%= @stock_batch.product.unit_of_measure&.symbol %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted text-center mb-0">No stock available for this batch</p>
          <% end %>
        </div>
      </div>

      <!-- Recent Transactions Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center bg-secondary text-white">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>
            Recent Transactions (Last 20)
          </h5>
        </div>
        <div class="card-body p-0">
          <% if @recent_transactions.any? %>
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Transaction Type</th>
                    <th>Location</th>
                    <th class="text-end">Quantity</th>
                    <th>By</th>
                  </tr>
                </thead>
                <tbody>
                  <% @recent_transactions.each do |txn| %>
                    <tr>
                      <td><%= txn.created_at.strftime('%b %d, %Y') %></td>
                      <td>
                        <span class="badge bg-info"><%= txn.txn_type %></span>
                      </td>
                      <td><%= txn.to_location&.name || '-' %></td>
                      <td class="text-end">
                        <span class="<%= txn.quantity >= 0 ? 'text-success' : 'text-danger' %>">
                          <%= txn.quantity >= 0 ? '+' : '' %><%= number_with_delimiter(txn.quantity, delimiter: ',') %>
                        </span>
                      </td>
                      <td><%= txn.created_by&.full_name || 'System' %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="p-4 text-center text-muted">
              <i class="fas fa-inbox fa-2x mb-2"></i>
              <p class="mb-0">No transactions yet for this batch</p>
            </div>
          <% end %>
        </div>
      </div>

    </div>

    <!-- Right Sidebar -->
    <div class="col-md-4">
      
      <!-- Current Stock Summary -->
      <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header d-flex align-items-center bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-boxes me-2"></i>
            Current Stock
          </h5>
        </div>
        <div class="card-body text-center py-4">
          <div class="display-4 mb-2">
            <strong class="<%= @current_stock > 0 ? 'text-success' : 'text-muted' %>">
              <%= number_with_delimiter(@current_stock, delimiter: ',') %>
            </strong>
          </div>
          <div class="h5 text-muted">
            <%= @stock_batch.product.unit_of_measure&.symbol %>
          </div>
          
          <% if @current_stock == 0 %>
            <div class="alert alert-warning mt-3 mb-0" role="alert">
              <small>
                <i class="fas fa-exclamation-triangle me-1"></i>
                No stock available
              </small>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Metadata Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center bg-light">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Metadata
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="text-muted small mb-1">Created By</label>
            <div><%= @stock_batch.created_by&.full_name || 'System' %></div>
          </div>
          <div class="mb-3">
            <label class="text-muted small mb-1">Created At</label>
            <div><%= @stock_batch.created_at.strftime('%b %d, %Y at %I:%M %p') %></div>
          </div>
          <div>
            <label class="text-muted small mb-1">Last Updated</label>
            <div><%= @stock_batch.updated_at.strftime('%b %d, %Y at %I:%M %p') %></div>
          </div>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center bg-light">
          <h6 class="mb-0">
            <i class="fas fa-bolt me-2"></i>
            Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <%= link_to inventory_stock_batches_path, class: "btn btn-outline-primary btn-sm w-100 mb-2" do %>
            <i class="fas fa-list me-1"></i> Back to Batches
          <% end %>
          <%= link_to edit_inventory_stock_batch_path(@stock_batch), class: "btn btn-outline-secondary btn-sm w-100 mb-2" do %>
            <i class="fas fa-edit me-1"></i> Edit Batch
          <% end %>
          <%= link_to inventory_stock_batches_path(product_id: @stock_batch.product_id), class: "btn btn-outline-info btn-sm w-100" do %>
            <i class="fas fa-filter me-1"></i> View Product Batches
          <% end %>
        </div>
      </div>

    </div>

  </div>

</div>

<style>

  .card-header h5, .card-header h6 {
    font-size: 1rem;
    font-weight: 600;
  }

  .badge {
    font-size: 0.85em;
    padding: 0.35em 0.65em;
  }

  .display-4 {
    font-size: 3rem;
    line-height: 1;
  }

  .table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
  }
</style>
