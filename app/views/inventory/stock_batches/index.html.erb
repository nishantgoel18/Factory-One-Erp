<!-- app/views/stock_batches/index.html.erb -->

<div class="main-content">
  <%= render 'layouts/alerts' %>

  <div class="page-header">
    <h2 class="header-title">Stock Batches</h2>
    <div class="header-sub-title">
      <nav class="breadcrumb breadcrumb-dash">
        <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
        <a class="breadcrumb-item" href="/inventory/dashboard">Inventory Management</a>
        <span class="breadcrumb-item active">Stock Batches</span>
      </nav>
    </div>
  </div>
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-6">
      <h2 class="mb-0">
        <i class="fas fa-barcode me-2"></i>
        Stock Batches
      </h2>
      <p class="text-muted mb-0">Manage batch-tracked inventory</p>
    </div>
    <div class="col-md-6 d-flex justify-content-end align-items-center">
      <%= link_to new_inventory_stock_batch_path, class: "btn btn-primary" do %>
        <i class="fas fa-plus me-1"></i> New Batch
      <% end %>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card  mb-4">
    <div class="card-body">
      <%= form_with url: inventory_stock_batches_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-3">
          <%= f.label :product_id, "Product", class: "form-label" %>
          <%= f.select :product_id, 
              options_from_collection_for_select(Product.where(is_batch_tracked: true).order(:name), :id, :name, params[:product_id]),
              { include_blank: "All Products" },
              { class: "form-control" } %>
        </div>

        <div class="col-md-3">
          <%= f.label :batch_number, "Batch Number", class: "form-label" %>
          <%= f.text_field :batch_number, 
              value: params[:batch_number],
              placeholder: "Search batch...",
              class: "form-control" %>
        </div>

        <div class="col-md-3">
          <%= f.label :status, "Status", class: "form-label" %>
          <%= f.select :status,
              options_for_select([
                ['All Batches', ''],
                ['Active', 'active'],
                ['Expiring Soon (30 days)', 'expiring_soon'],
                ['Expired', 'expired']
              ], params[:status]),
              {},
              { class: "form-control" } %>
        </div>

        <div class="col-md-3 d-flex align-items-end">
          <%= f.submit "Filter", class: "btn btn-secondary me-2" %>
          <%= link_to "Reset", inventory_stock_batches_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="card  mb-3">
    <div class="card-body py-2">
      <small class="text-muted">
        Showing <%= @stock_batches.count %> batches
        <% if params[:product_id].present? || params[:batch_number].present? || params[:status].present? %>
          (filtered)
        <% end %>
      </small>
    </div>
  </div>

  <!-- Batches Table -->
  <div class="card ">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Batch Number</th>
            <th>Product</th>
            <th>Manufacture Date</th>
            <th>Expiry Date</th>
            <th>Supplier Ref</th>
            <th class="text-end">Current Stock</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @stock_batches.any? %>
            <% @stock_batches.each do |batch| %>
              <tr>
                <!-- Batch Number -->
                <td>
                  <strong><%= link_to batch.batch_number, inventory_stock_batch_path(batch), class: "text-decoration-none" %></strong>
                </td>

                <!-- Product -->
                <td>
                  <div class="text-truncate" style="max-width: 200px;" title="<%= batch.product.name %>">
                    <%= batch.product.sku %> - <%= batch.product.name %>
                  </div>
                </td>

                <!-- Manufacture Date -->
                <td>
                  <% if batch.manufacture_date.present? %>
                    <%= batch.manufacture_date.strftime('%b %d, %Y') %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>

                <!-- Expiry Date -->
                <td>
                  <% if batch.expiry_date.present? %>
                    <%= batch.expiry_date.strftime('%b %d, %Y') %>
                    <% days_to_expire = (batch.expiry_date - Date.today).to_i %>
                    <% if days_to_expire < 0 %>
                      <br><small class="text-danger"><%= days_to_expire.abs %> days ago</small>
                    <% elsif days_to_expire <= 30 %>
                      <br><small class="text-warning">in <%= days_to_expire %> days</small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">No expiry</span>
                  <% end %>
                </td>

                <!-- Supplier Reference -->
                <td>
                  <%= batch.supplier_batch_ref.presence || '-' %>
                </td>

                <!-- Current Stock -->
                <td class="text-end">
                  <% current_stock = batch.respond_to?(:current_stock) ? batch.current_stock : 0 %>
                  <strong class="<%= current_stock > 0 ? 'text-success' : 'text-muted' %>">
                    <%= number_with_delimiter(current_stock, delimiter: ',') %>
                  </strong>
                  <%= batch.product.unit_of_measure&.symbol %>
                </td>

                <!-- Status Badge -->
                <td>
                  <% if batch.expiry_date.present? %>
                    <% days_to_expire = (batch.expiry_date - Date.today).to_i %>
                    <% if days_to_expire < 0 %>
                      <span class="text-white badge bg-danger">Expired</span>
                    <% elsif days_to_expire <= 30 %>
                      <span class="text-white badge bg-warning text-dark">Expiring Soon</span>
                    <% else %>
                      <span class="text-white badge bg-success">Active</span>
                    <% end %>
                  <% else %>
                    <span class="text-white badge bg-primary">Active</span>
                  <% end %>
                </td>

                <!-- Actions -->
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <%= link_to inventory_stock_batch_path(batch), class: "btn btn-outline-primary", title: "View" do %>
                      View
                    <% end %>
                    <%= link_to edit_inventory_stock_batch_path(batch), class: "btn btn-outline-secondary", title: "Edit" do %>
                      Edit
                    <% end %>
                    <%= link_to inventory_stock_batch_path(batch), 
                        method: :delete,
                        data: { confirm: "Are you sure you want to delete batch #{batch.batch_number}?" },
                        class: "btn btn-outline-danger",
                        title: "Delete" do %>
                      Delete
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="8" class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-0">No batches found</p>
                <% if params[:product_id].present? || params[:batch_number].present? || params[:status].present? %>
                  <p class="text-muted">Try adjusting your filters</p>
                <% else %>
                  <%= link_to "Create your first batch", new_inventory_stock_batch_path, class: "btn btn-primary mt-3" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <% if @stock_batches.any? %>
      <div class="card-footer">
        <%= paginate @stock_batches %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .table thead th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
  }

  .table td {
    vertical-align: middle;
  }

  .badge {
    padding: 0.35em 0.65em;
    font-size: 0.85em;
    font-weight: 500;
  }

  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
  }
</style>
