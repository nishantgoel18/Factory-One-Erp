<%# app/views/inventory/goods_receipts/index.html.erb %>

<div class="main-content">
    <%= render 'layouts/alerts' %>

    <div class="page-header">
        <h2 class="header-title">Goods Receipts</h2>
        <div class="header-sub-title">
            <nav class="breadcrumb breadcrumb-dash">
                <a href="/" class="breadcrumb-item"><i class="anticon anticon-home m-r-5"></i>Home</a>
                <a class="breadcrumb-item" href="/inventory/dashboard">Inventory Management</a>
                <span class="breadcrumb-item active">Goods Receipts</span>
            </nav>
        </div>
    </div>
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-0">
          <i class="bi bi-box-seam me-2"></i>
          Goods Receipts (GRN)
        </h2>
        <p class="text-muted mb-0">Receive inventory into warehouses</p>
      </div>
      <div class="btn-group">
        <%= link_to new_inventory_goods_receipt_path, class: 'btn btn-primary' do %>
          <i class="bi bi-plus-circle me-1"></i>
          New GRN
        <% end %>
        <%= link_to open_pos_inventory_purchase_orders_path, class: 'btn btn-outline-primary' do %>
          <i class="bi bi-cart-check me-1"></i>
          From Open PO
        <% end %>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <%= form_with url: inventory_goods_receipts_path, method: :get, class: 'row g-3' do |f| %>
          <div class="col-md-3">
            <%= f.label :search, 'Search', class: 'form-label' %>
            <%= f.text_field :search, 
                value: params[:search], 
                class: 'form-control', 
                placeholder: 'GRN Number...' %>
          </div>

          <div class="col-md-2">
            <%= f.label :warehouse_id, 'Warehouse', class: 'form-label' %>
            <%= f.select :warehouse_id, 
                options_from_collection_for_select(
                  Warehouse.where(deleted: false, is_active: true).order(:name), 
                  :id, :name, params[:warehouse_id]
                ),
                { include_blank: 'All Warehouses' },
                { class: 'form-control' } %>
          </div>

          <div class="col-md-2">
            <%= f.label :status, 'Status', class: 'form-label' %>
            <%= f.select :status,
                options_for_select([['Draft', 'DRAFT'], ['Posted', 'POSTED']], params[:status]),
                { include_blank: 'All Statuses' },
                { class: 'form-control' } %>
          </div>

          <div class="col-md-2">
            <%= f.label :from_date, 'From Date', class: 'form-label' %>
            <%= f.date_field :from_date, value: params[:from_date], class: 'form-control' %>
          </div>

          <div class="col-md-2">
            <%= f.label :to_date, 'To Date', class: 'form-label' %>
            <%= f.date_field :to_date, value: params[:to_date], class: 'form-control' %>
          </div>

          <div class="col-md-1 d-flex align-items-end">
            <%= f.submit 'Filter', class: 'btn btn-secondary w-100' %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-4">
        <%= link_to inventory_goods_receipts_path(status: 'DRAFT'), class: 'text-decoration-none' do %>
          <div class="card border-warning">
            <div class="card-body">
              <h5 class="card-title text-warning">
                <i class="bi bi-file-earmark-text"></i> Draft GRNs
              </h5>
              <h3 class="mb-0"><%= GoodsReceipt.draft.count %></h3>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-md-4">
        <div class="card border-success">
          <div class="card-body">
            <h5 class="card-title text-success">
              <i class="bi bi-check-circle"></i> Posted Today
            </h5>
            <h3 class="mb-0">
              <%= GoodsReceipt.posted
                    .where('posted_at >= ?', Date.current.beginning_of_day)
                    .count %>
            </h3>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card border-info">
          <div class="card-body">
            <h5 class="card-title text-info">
              <i class="bi bi-calendar-week"></i> This Month
            </h5>
            <h3 class="mb-0">
              <%= GoodsReceipt.active
                    .where('receipt_date >= ?', Date.current.beginning_of_month)
                    .count %>
            </h3>
          </div>
        </div>
      </div>
    </div>

    <!-- GRN Table -->
    <div class="card">
      <div class="card-body">
        <% if @goods_receipts.any? %>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>GRN Number</th>
                  <th>PO Reference</th>
                  <th>Warehouse</th>
                  <th>Supplier</th>
                  <th>Receipt Date</th>
                  <th>Status</th>
                  <th>Total Lines</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @goods_receipts.each do |grn| %>
                  <tr>
                    <td>
                      <%= link_to grn.reference_no, inventory_goods_receipt_path(grn), 
                          class: 'fw-bold text-decoration-none' %>
                    </td>
                    <td>
                      <% if grn.purchase_order %>
                        <%= link_to grn.purchase_order.po_number, 
                            inventory_purchase_order_path(grn.purchase_order),
                            class: 'text-decoration-none' %>
                      <% else %>
                        <span class="text-muted">Direct Receipt</span>
                      <% end %>
                    </td>
                    <td>
                      <i class="bi bi-building me-1"></i>
                      <%= grn.warehouse.name %>
                    </td>
                    <td>
                      <%= grn.supplier&.name || 'N/A' %>
                    </td>
                    <td>
                      <i class="bi bi-calendar me-1"></i>
                      <%= grn.receipt_date.strftime('%b %d, %Y') %>
                    </td>
                    <td>
                      <%= render 'shared/status_badge', status: grn.status %>
                    </td>
                    <td>
                      <%= grn.total_lines %> lines
                      <% if grn.status == 'POSTED' %>
                        <br><small class="text-success">
                          <%= grn.total_quantity.to_i %> units received
                        </small>
                      <% end %>
                    </td>
                    <td class="text-end">

                      <div class="btn-group" role="group">
                        <%= link_to inventory_goods_receipt_path(grn), 
                            class: 'btn btn-sm btn-outline-primary',
                            title: 'View' do %>
                          View
                        <% end %>
                        
                        <% if grn.can_edit? %>
                          <%= link_to edit_inventory_goods_receipt_path(grn), 
                              class: 'btn btn-sm btn-outline-secondary',
                              title: 'Edit' do %>
                            Edit
                          <% end %>
                        <% end %>
                        
                        
                        <% if grn.can_post? %>
                          <%= link_to post_receipt_inventory_goods_receipt_path(grn), 
                              method: :post,
                              data: { confirm: 'Post this GRN? Stock levels will be updated.' },
                              class: 'btn btn-sm btn-outline-success' do %>
                            <i class="bi bi-check-circle me-2"></i>Post Receipt
                          <% end %>
                        <% end %>
                            
                        <%= link_to print_inventory_goods_receipt_path(grn, format: :pdf), 
                            target: '_blank',
                            class: 'btn btn-sm btn-outline' do %>
                          <i class="bi bi-printer me-2"></i>Print GRN
                        <% end %>
                            
                        <% if grn.can_edit? %>
                          <%= link_to inventory_goods_receipt_path(grn), 
                              method: :delete,
                              data: { confirm: 'Delete this GRN?' },
                              class: 'btn btn-sm btn-outline-danger' do %>
                            <i class="bi bi-trash me-2"></i>Delete
                          <% end %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
              Showing <%= @goods_receipts.offset_value + 1 %> to 
              <%= [@goods_receipts.offset_value + @goods_receipts.length, @goods_receipts.total_count].min %> 
              of <%= @goods_receipts.total_count %> receipts
            </div>
            <%= paginate @goods_receipts %>
          </div>
        <% else %>
          <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="mt-3 text-muted">No goods receipts found</h5>
            <p class="text-muted">Create a GRN to receive inventory</p>
            <%= link_to 'Create GRN', new_inventory_goods_receipt_path, 
                class: 'btn btn-primary mt-2' %>
          </div>
        <% end %>
      </div>
    </div>
</div>