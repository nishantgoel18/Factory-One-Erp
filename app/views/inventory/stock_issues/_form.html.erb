<%= simple_form_for [:inventory, @stock_issue] do |f| %>
<%= render 'layouts/error_messages', object: @stock_issue %>
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <h5 class="mb-0">Issue Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-12">
          <%= f.association :warehouse,
              collection: Warehouse.where(deleted: false, is_active: true).order(:name),
              input_html: { class: 'form-control' } %>
        </div>
        <%= f.input :status, as: :hidden, input_html: {value: StockIssue::STATUS_DRAFT} %>

      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Items to Issue</h5>
      <button type="button" class="btn btn-sm btn-light" id="add-issue-line">
        Add Item
      </button>
    </div>
    <div class="card-body">
      <div id="issue-lines-container">
        <%= f.simple_fields_for :lines do |line_form| %>
          <%= render 'line_fields', f: line_form %>
        <% end %>
      </div>

      <template id="issue-line-template">
        <%= f.simple_fields_for :lines, StockIssueLine.new, child_index: 'NEW_RECORD' do |line_form| %>
          <%= render 'line_fields', f: line_form %>
        <% end %>
      </template>
    </div>
  </div>

  <div class="d-flex justify-content-between">
    <%= link_to 'Cancel', inventory_stock_issues_path, class: 'btn btn-secondary' %>
    <%= f.submit 'Save Issue', class: 'btn btn-primary' %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add new line item
  document.getElementById('add-issue-line').addEventListener('click', function() {
    const template = document.getElementById('issue-line-template');
    const content = template.content.cloneNode(true);
    const html = content.firstElementChild.outerHTML.replace(/NEW_RECORD/g, new Date().getTime());
    document.getElementById('issue-lines-container').insertAdjacentHTML('beforeend', html);
  });
  
  // Remove line item
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-issue-line')) {
      const lineItem = e.target.closest('.issue-line-row');
      const destroyInput = lineItem.querySelector('input[name*="_destroy"]');
      
      if (destroyInput) {
        destroyInput.value = '1';
        lineItem.style.display = 'none';
      } else {
        lineItem.remove();
      }
    }
  });
});
</script>
