<%= render 'layouts/error_messages', object: f.object %>
<div class="row">
    <div class="col-lg-12">
        <label>Name:</label>
        <%= f.text_field :name, class: "form-control" %>
  
        <br />
    </div>
    <div class="col-lg-4">
        <label>Code:</label>
        <%= f.text_field :code, class: "form-control" %>
        <br />
    </div>

    <div class="col-lg-4">
        <label>Product:</label>
        <%= f.collection_select :product_id, Product.bom_products.where(deleted: false), :id, :name,
          { prompt: "Select Product" }, class: "form-control" %>
        <br />
    </div>

    <div class="col-lg-4">
        <label>Revision:</label>
        <%= f.text_field :revision, class: "form-control" %>
        <br />
    </div>

    <div class="col-lg-6">
        <label>Effective From:</label>
        <%= f.date_field :effective_from, class: "form-control" %>
        <br />
    </div>

    <div class="col-lg-6">
        <label>Effective To:</label>
        <%= f.date_field :effective_to, class: "form-control" %>
        <br />
    </div>

    <div class="col-lg-12">
        <label>Notes:</label>
        <%= f.text_area :notes, class: "form-control", rows: 3 %>
        <br />
    </div>
</div>

<h3>BOM Items</h3>
<hr />

<div class="form-group bomItemFields">
    <!-- Existing BOM items (if editing) -->
    <% f.object.bom_items.each do |item| %>
        <div class="bomItem" style="border: 1px solid #efefef; padding: 10px;">
            <div class="row">
                <div class="col-lg-3">
                    <label>Component</label>
                    <select name="bom_item[existing][<%= item.id %>]component" class="form-control">
                        <% Product.bom_item_components.each do |product| %>
                            <option value="<%=  product.id  %>" <% if product.id == item.component_id %> selected <% end %>><%=  product.name  %></option>
                        <% end -%>
                    </select>
                    <br />
                </div>

                <div class="col-lg-3">
                    <label>Quantity</label>
                    <input type="number" step="0.01" min='0' min="0.01" name="bom_item[existing][<%= item.id %>]quantity"
                        class="form-control" value="<%= item.quantity %>" required>
                        <br />
                </div>
                <div class="col-lg-3">
                    <label>UOM</label>
                    <select name="bom_item[existing][<%= item.id %>]uom" class="form-control">
                        <% UnitOfMeasure.all.each do |uom| %>
                            <option value="<%=  uom.id  %>" <% if uom.id == item.uom_id %>selected<% end %>><%=  uom.name  %></option>
                        <% end -%>
                    </select>
                    <br />
                </div>
                <div class="col-lg-3">
                    <label>Scrap %</label>
                    <input type="number" step="0.01" min="0" max="100" name="bom_item[existing][<%= item.id %>]scrap_percent"
                        class="form-control" value="<%= item.scrap_percent %>" required>
                        <br />
                </div>

                <div class="col-lg-3">
                    <label>Destroy</label>
                    <select name="bom_item[existing][<%= item.id %>]destroy" class="form-control">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <br />
                </div>

                <div class="col-lg-12">
                    <label>Line Note</label>
                    <textarea name="bom_item[existing][<%= item.id %>]line_note" class="form-control"
                        rows="3"><%=  item.line_note  %></textarea>
                    <br />

                </div>
                <div class="col-lg-1">
                    <a href="#" class="removeBOMItem" onclick="$(this).closest('.bomItem').remove(); event.preventDefault();">Remove</a>
                    <br />
                </div>
            </div>
        </div>
    <% end -%>
</div>

<div class="form-group">
    <a href="#" id="addBOMItem">Add BOM Item</a>
    <br />         
</div>

<div class="removedExistingBOMItems"></div>

<div class="form-group">
    <hr />
    <%= f.submit "Submit", class: "btn btn-success btn-sm" %>
</div>
<script>
    var addBOMItem = function () {
        var newItemNumber = $('.bomItemFields').children('.bomItem').length + 1;
        $('.bomItemFields').append(`
            <div class="bomItem" style="border: 1px solid #efefef; padding: 10px;">
                <div class = "row">
                    <div class="col-lg-3">
                        <label>Component</label>
                        <select name="bom_item[new][${newItemNumber}]component" class="form-control">
                            <% Product.bom_item_components.each do |product| %>
                                <option value="<%= product.id %>"><%= product.name %></option>
                            <% end -%>
                        </select>
                        <br />

                    </div>
                    <div class="col-lg-3">
                        <label>Quantity</label>
                        <input type="number" step="0.01" min='0.01' name="bom_item[new][${newItemNumber}]quantity" class="form-control" required>
                        <br />

                    </div>
                    <div class="col-lg-3">
                        <label>UOM</label>
                        <select name="bom_item[new][${newItemNumber}]uom" class="form-control">
                            <% UnitOfMeasure.all.each do |uom| %>
                                <option value="<%= uom.id %>"><%= uom.name %></option>
                            <% end -%>
                        </select>
                        <br />

                    </div>
                    <div class="col-lg-3">
                        <label>Scrap %</label>
                        <input type="number" step="0.01" min="0" max="100" name="bom_item[new][${newItemNumber}]scrap_percent" class="form-control" value="0.00" required>
                        <br />

                    </div>
                    
                    <div class="col-lg-12">
                        <label>Line Note</label>
                        <textarea name="bom_item[new][${newItemNumber}]line_note" class="form-control" rows="3"></textarea>
                        <br />

                    </div>

                    <div class="col-lg-1">
                        <a href="#" class="removeBOMItem" onclick="$(this).closest('.bomItem').remove(); event.preventDefault();">Remove</a>
                        <br />
                    </div>
                </div>
            </div>
        `);
    };

    $('#addBOMItem').click(function (e) {
        e.preventDefault();
        addBOMItem();
    });
    <% if @bill_of_material.bom_items.blank? %>
        addBOMItem();
    <% end -%>
</script>